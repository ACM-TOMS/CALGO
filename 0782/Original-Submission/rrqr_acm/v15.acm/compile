#!/bin/csh -f
# Script to compile ls code.
#
# Setting user flags for preprocessing.
#

#set usercppflags = "-DDEBUGRANK -DERRORCHECK -DBOUNDSCHECK -DCOMPFLOPS"
#set usercppflags = "-DERRORCHECK -DCHECKPOSTARGS -DBOUNDSCHECK -DCOMPFLOPS"
#set usercppflags = "-DDEBUGRANK -DERRORCHECK -DBOUNDSCHECK -DCOMPFLOPS"
set usercppflags = "-DERRORCHECK -DBOUNDSCHECK -DCOMPFLOPS"
#set usercppflags = "-DBOUNDSCHECK -DCOMPFLOPS"
#set usercppflags = "-DCOMPFLOPS"

#
# Start of the rest of the script.
#
if ($#argv < 2) goto usage
set compmode = $1
set prec = $2
set version = $3
switch ("$compmode")
  case "opt":	
    breaksw
  case "dbg":	
    breaksw
  default:
    echo "Bad mode of compilation"
    goto usage
endsw
switch ("$version")
  case "hp-nuvol":	
    switch ("$compmode")
      case "opt":	
        set flags = "+O2"
        breaksw
      case "dbg":	
        set flags = "-g -C"
        breaksw
    endsw
    set machine = "HP"
    set cpp = "/lib/cpp"
    set cppflags = ""
    set fc = "/opt/fortran/bin/f77"
    set fcflags = "-c -u $flags"
    set ld = "/opt/fortran/bin/f77"
    set ldflags = "+U77 $flags"
    set blas = "/opt/fortran/lib/pa1.1/libblas.a"
    set lapack = "-ltmglib-2 -llapack-2"
    breaksw
  case "hp-iti":	
    switch ("$compmode")
      case "opt":	
        set flags = "+O2"
        breaksw
      case "dbg":	
        set flags = "-g -C"
        breaksw
    endsw
    set machine = "HP"
    set cpp = "/lib/cpp"
    set cppflags = ""
    set fc = "f77"
    set fcflags = "-c -u $flags"
    set ld = "f77"
    set ldflags = "+U77 $flags"
    set blas = "/usr/local/lib/lapack/blas.f77.a"
#    set blas = "/usr/local/lib/lapack/blas.hp-pa1.1.a"
    set lapack = "/usr/local/lib/lapack/tmglib-2.a /usr/local/lib/lapack/lapack-2.a"
    breaksw
  case "sun*":	
    switch ("$compmode")
      case "opt":	
        set flags = "-O"
        breaksw
      case "dbg":
        set flags = "-g -C"
        breaksw
    endsw
    set machine = "SUN"
    set cpp = "/lib/cpp"
    set cppflags = ""
    set fc = "f77"
    set fcflags = "-c -u $flags"
    set ld = "f77"
    set ldflags = "$flags"
    set blas = "/usr/local/lib/blas.a"
    set lapack = "/usr/local/lib/tmglib.a /usr/local/lib/lapack.a"
    breaksw
 case "solaris":
    switch ("$compmode")
      case "opt":
        set flags = "-O"
        breaksw
      case "dbg":
        set flags = "-g -C"
        breaksw
    endsw
    set machine = "SUN"
    set cpp = "/usr/ccs/lib/cpp"
    set cppflags = ""
    set fc = "f77"
    set fcflags = "-c -u -dalign $flags"
    set ld = "f77"
    set ldflags = "-dalign $flags"
    set blas = "/home1/SUNWspro/SC3.0.1/lib/libsunperf.a"
    set lapack = "/home1/lapack/tmglib.a"
    breaksw
  case "sgi":	
    switch ("$compmode")
      case "opt":	
        set flags = "-O"
        breaksw
      case "dbg":	
        set flags = "-g"
        breaksw
    endsw
    set machine = "IRIX"
    set cpp = "/lib/cpp"
    set cppflags = ""
    set fc = "f77"
    set fcflags = "-c -64 -mips4 -nocpp $flags"
    set ld = "f77"
    set ldflags = "$flags"
    set blas = ""
    set lapack = "/usr/lib/libtmglib-2.a -lcomplib.sgimath"
    breaksw
  case "rs6000":
    switch ("$compmode")
      case "opt":	
        set flags = "-O3"
        breaksw
      case "dbg":	
        set flags = "-g -C"
        breaksw
    endsw
    set machine = "RS6K"
    set cpp = "/lib/cpp"
    set cppflags = ""
    set fc = "xlf"
    set fcflags = "-c -u $flags"
    set ld = "xlf"
    set ldflags = "$flags"
    set blas = "-lessl -lblas"
    set lapack = "/usr/local/lapack/lib/tmglib.a /usr/local/lapack/lib/lapack.a"
    breaksw
  case "alpha":
    switch ("$compmode")
      case "opt":	
        set flags = "-O"
        breaksw
      case "dbg":
        set flags = "-g -C"
        breaksw
    endsw
    set machine = "ALPHA"
    set cpp = "/lib/cpp"
    set cppflags = "-C"
    set fc = "f77"
    set fcflags = "-c -u $flags"
    set ld = "f77"
    set ldflags = "$flags"
    set blas = ""
    set lapack = "-ldxml ../../axplib/tmglib.a ../../axplib/dsecnd.o"
    breaksw
  default:
    echo "Machine not recognized"
    goto usage
endsw

echo ${prec}qr_$version \
	PRECISION="$prec" \
	VERSION="$version" \
	FC="$fc" \
	FCFLAGS="$fcflags" \
	LD="$ld" \
	LDFLAGS="$ldflags" \
	CPP="$cpp" \
	CPPFLAGS="$cppflags -D$machine $usercppflags" \
	LAPACK="$lapack" \
	BLAS="$blas"
make ${prec}qr_$version \
	PRECISION="$prec" \
	VERSION="$version" \
	FC="$fc" \
	FCFLAGS="$fcflags" \
	LD="$ld" \
	LDFLAGS="$ldflags" \
	CPP="$cpp" \
	CPPFLAGS="$cppflags -D$machine $usercppflags" \
	LAPACK="$lapack" \
	BLAS="$blas"
exit 0

usage:
	echo "usage: $0 <compmode> <prec> <machine>"
        echo "          <compmode> = opt or dbg"
        echo "          <prec> = s or d"
        echo "          <machine> = sun4, hp, rs6000 or others"
        exit 1
