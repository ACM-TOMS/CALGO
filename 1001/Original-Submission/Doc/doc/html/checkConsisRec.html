
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>checkConsisRec</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-04-30"><meta name="DC.source" content="checkConsisRec.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>checkConsisRec</h1><!--introduction--><p>The input parameters for the variational reconstruction process are checked for consistency and set or corrected whenever necessary.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Syntax</a></li><li><a href="#2">Description</a></li><li><a href="#3">Input Arguments</a></li><li><a href="#4">Output Argument</a></li><li><a href="#5">See Also</a></li><li><a href="#6">Code</a></li></ul></div><h2 id="1">Syntax</h2><pre class="language-matlab">seti = checkConsisRec(seti)
seti = checkConsisRec(seti,dispDepth)
</pre><h2 id="2">Description</h2><p><tt>seti = checkConsisRec(seti)</tt> checks the existence and consistency of some field in structure array seti.</p><p><tt>seti = checkConsisRec(seti,dispDepth)</tt> does the same but allows to control the depth of displayed messages by <tt>dispDepth</tt> (0: no, 1 or greater: yes).</p><p>See the section Code to get links to parameters' references.</p><h2 id="3">Input Arguments</h2><div><ul><li><tt>seti</tt>        :   struct seti</li></ul></div><p><b>Optional Input Argument</b></p><div><ul><li><tt>dispDepth</tt>   : Depth of displayed messages (0: no, 1 or greater: yes).</li></ul></div><p><b>Optional Input Arguments of structure <tt>seti</tt></b></p><p>If the fields does not exist, default values are set in this function.</p><div><ul><li><tt>seti.useWavelet</tt>   : Use wavelets for reconstruction (default: 0).                         Note that wavelets are not supported in the                         public version of this code. Therefore the                         wavelet-specific fields <tt>wavWeight</tt>,                         <tt>genWhiteNoiseNew</tt>, <tt>adaptWeightsMan</tt>, <tt>wavelet</tt>,                         <tt>extension</tt>, <tt>smin</tt> and <tt>samples</tt> are not                         documented.</li><li><tt>seti.recname</tt>      : What is reconstructed? A <tt>'constrast'</tt> (default)                         or a <tt>'source'</tt>. Influences the title in                         <a href="subplots.html">subplots.html</a>.</li><li><tt>seti.physBounds</tt>   : Bounds for real/imaginary part of contrast:                         [reMin, reMax, imMin, imMax]                         (default: [-1,3,0,3])                         (consider also the penalty for physical bounds in                         <a href="pda.html">pda.html</a> Section "More About".)</li><li><tt>seti.tolDelta</tt>     : Tolerance for physical bounds' delta-function                         (default: 1E-14) in <a href="setFuncsPda.html">setFuncsPda.html</a>.</li><li><tt>seti.useDis</tt>       : If it is 1 (default), the discrepancy principle                         is used to stop the outer iteration. (Otherwise 0).</li><li><tt>seti.nOut</tt>         : Maximal number of outer iterations (default: 30).</li></ul></div><p>If the primal-dual algorithm is used (|seti.inv = 'pda') and the following fields does not exist, default values are set in this function.</p><div><ul><li><tt>seti.pdaN</tt>         : Number of inner iterations (PDA) (default: 50) (see <a href="pda.html">pda.html</a>).</li><li><tt>seti.pdaStepsize</tt>  : Method to choose primal and dual stepsizes                         (<tt>'fix'</tt> (default) or <tt>'adaptive'</tt>)                         see <a href="pdaChoosingStepsizes.html">pdaChoosingStepsizes.html</a>.</li><li><tt>seti.vartheta</tt>     : Parameter in (0,1) used in case of adaptive stepsizes,                         see <a href="pdaChoosingStepsizes.html">pdaChoosingStepsizes.html</a>.</li><li><tt>seti.useTolIn</tt>     : If it is set to 1 (default: 0), the inner                         tolerance principle is used to stop the inner                         iterations (primal-dual algorithm), see                         <a href="minPda.html">minPda.html</a> and <a href="minTolIn.html">minTolIn.html</a>.</li><li><tt>seti.useTolOut</tt>    : If it is set to 1 (default: 0), the outer                         tolerance principle is used to stop the inner                         iterations, see <a href="minPda.html">minPda.html</a>, <a href="minTolOut.html">minTolOut.html</a>.</li></ul></div><p>In case of <tt>seti.inv = 'pda'</tt> and <tt>seti.useTolIn = 1</tt> and the following fields does not exist, default values are set in this function.</p><div><ul><li><tt>seti.ThetaStart</tt>   : (default: 0.925), see <a href="minTolIn.html">minTolIn.html</a>.</li><li><tt>seti.ThetaMax</tt>     : (default: 0.95), see <a href="minTolIn.html">minTolIn.html</a>.</li><li><tt>seti.TolGamma</tt>     : (default: 0.90), see <a href="minTolIn.html">minTolIn.html</a>.</li><li><tt>seti.pdaNmax</tt>      : Maximal iteration number, if <tt>seti.useTolIn</tt> or                         <tt>seti.useTolOut</tt> are 1 (default : 250).</li></ul></div><p>In case of <tt>seti.inv = 'pda'</tt> and <tt>seti.useTolOut = 1</tt> and the following fields does not exist, default values are set in this function.</p><div><ul><li><tt>seti.relDisTol</tt>    : Outer tolerance (default: 0.05), see <a href="minTolOut.html">minTolOut.html</a>.</li><li><tt>seti.pdaNmax</tt>      : Maximal iteration number, if <tt>seti.useTolIn</tt> or                         <tt>seti.useTolOut</tt> are 1 (default : 250).</li></ul></div><p>In case of <tt>seti.inv = 'pda'</tt> and the usage of <tt>fp2</tt> (see <a href="setInvType.html">setInvType.html</a>), that is not supported in the public versions it is checked if the following fields exist and are not empty. Otherwise the program is stopped.</p><div><ul><li><tt>seti.obsMask</tt>      : Mask of pixels in ROI the assumed obstacle                         (e.g. by factorization method)                         stored as logical vector of size seti.nROI^seti.dim x 1.</li></ul></div><p>The following fields should have been set in <a href="setInvType.html">setInvType.html</a>:</p><div><ul><li><tt>seti.inv</tt></li><li><tt>seti.alpha</tt></li><li><tt>seti.beta</tt></li><li><tt>seti.pNorm</tt></li><li><tt>seti.qNorm</tt></li><li><tt>seti.tau</tt></li></ul></div><p>See <a href="recon.html">recon.html</a> for the following fields of <tt>seti</tt>:</p><div><ul><li><tt>seti.saveqROIcomp</tt></li><li><tt>seti.loadqROIcomp</tt></li><li><tt>seti.savedata</tt></li></ul></div><p>Currently unused fields:</p><div><ul><li><tt>seti.lambda</tt>   : Wavelength (default: <img src="checkConsisRec_eq17780364819335905377.png" alt="$\lambda = 2\pi/k$"> with                     wave number <img src="checkConsisRec_eq02025168988717450165.png" alt="$k = \texttt{seti.k}$">) (currently not used anywhere).</li></ul></div><h2 id="4">Output Argument</h2><div><ul><li><tt>seti</tt>  : structure array, see "Optional Input Arguments of structure <tt>seti</tt>", because default values are set, if fields was not already defined.</li></ul></div><div><ul><li><tt>seti.usefp2</tt>       : 1 if <tt>fp2</tt> is used in <tt>seti.tF</tt> or <tt>seti.tG</tt> (otherwise 0)                         (not supported in public version.)</li></ul></div><h2 id="5">See Also</h2><div><ul><li><a href="recon.html">recon.html</a></li><li><a href="minPda.html">minPda.html</a></li><li><a href="pda.html">pda.html</a></li></ul></div><h2 id="6">Code</h2><pre class="codeinput"><span class="keyword">function</span> seti = checkConsisRec(seti,dispDepth)
</pre><p><b>setWavelet</b></p><p>Wavelets are not supported in public version.</p><pre class="codeinput">seti = checkfield(seti,<span class="string">'useWavelet'</span>,0,dispDepth);

<span class="keyword">if</span> seti.useWavelet == 1
</pre><pre class="codeinput">    seti = checkfield(seti,<span class="string">'wavWeight'</span>,0,dispDepth);
    seti = checkfield(seti,<span class="string">'genWhiteNoiseNew'</span>,0,dispDepth);

    <span class="keyword">if</span> seti.dim == 2
        seti = checkfield(seti,<span class="string">'adaptWeightsMan'</span>,1,dispDepth);
    <span class="keyword">elseif</span> seti.dim == 3
        seti = checkfield(seti,<span class="string">'adaptWeightsMan'</span>,0,dispDepth);
        disp(<span class="string">'Note: Parameter "adaptWeightsMan" = 1 is not supported in case of seti.dim = 3 yet.'</span>)
    <span class="keyword">else</span>
        error(<span class="string">'Dimension has to be 2 or 3, see checkConsisRec.m'</span>)
    <span class="keyword">end</span>

    seti = checkfield(seti,<span class="string">'wavelet'</span>,<span class="string">'cdf97'</span>,dispDepth);

    seti = checkfield(seti,<span class="string">'extension'</span>,<span class="string">'symmetric'</span>,dispDepth); <span class="comment">% extension: symmetric or zeropadded</span>

    <span class="keyword">if</span> ~( isfield(seti,<span class="string">'smin'</span>) &amp;&amp; <span class="keyword">...</span>
            (seti.smin == round(seti.smin)) &amp;&amp; (seti.smin &gt;= 8) )
        seti.smin = 8;
        setmessage(seti,<span class="string">'smin'</span>,dispDepth);
    <span class="keyword">end</span>

    <span class="keyword">if</span> ~( isfield(seti,<span class="string">'samples'</span>) &amp;&amp; <span class="keyword">...</span>
            (seti.samples == round(seti.samples)) &amp;&amp; (seti.samples &gt;= 1000) )
        seti.samples = 10000;
        setmessage(seti,<span class="string">'samples'</span>,dispDepth);
    <span class="keyword">end</span>
</pre><p><b>Example for a complete but long consistency check in case of seti.wavelet</b></p><pre class="codeinput"><span class="comment">%     if ~( isfield(seti,'wavelet') &amp;&amp; ...</span>
<span class="comment">%             ( strcmp(seti.wavelet,'cdf97') || strcmp(seti.wavelet,'haar') || strcmp(seti.wavelet,'legall53') ) )</span>
<span class="comment">%         seti.wavelet = 'cdf97';</span>
<span class="comment">%         setmessage(seti,'wavelet');</span>
<span class="comment">%     end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p><b>Variational reconstruction process</b></p><p>For reference see</p><div><ul><li><a href="recon.html">recon.html</a></li><li><a href="setInvType.html">setInvType.html</a></li><li><a href="pda.html">pda.html</a></li><li><a href="setFuncsPda.html">setFuncsPda.html</a></li></ul></div><pre class="codeinput">seti = checkfield(seti,<span class="string">'inv'</span>,<span class="string">'pda'</span>,dispDepth);
seti = checkfield(seti,<span class="string">'recname'</span>,<span class="string">'contrast'</span>,dispDepth); <span class="comment">% recname: contrast or source</span>

<span class="comment">% -</span>

seti = checkfield(seti,<span class="string">'alpha'</span>,500,dispDepth);
seti = checkfield(seti,<span class="string">'beta'</span>,1E-5,dispDepth);

seti = checkfield(seti,<span class="string">'pNorm'</span>,2,dispDepth);
seti = checkfield(seti,<span class="string">'qNorm'</span>,1,dispDepth);

seti = checkfield(seti,<span class="string">'physBounds'</span>,[-1,3,0,3],dispDepth);

<span class="keyword">if</span> seti.useWavelet == 1 &amp;&amp; strcmp(seti.inv,<span class="string">'shrinkage'</span>)
    seti.physBounds = [-inf,inf,-inf,inf]; <span class="comment">% no bounds for wavelet coefficients</span>
    <span class="comment">% in case of pda physBounds can be used in wavelet case too</span>
    disp(<span class="string">'Wavelets are used and shrinkage is used...'</span>);
    disp(<span class="string">'... so set parameter "physBounds" to [-inf,inf,-inf,inf].'</span>);
<span class="keyword">end</span>

seti = checkfield(seti,<span class="string">'tolDelta'</span>,1E-14,dispDepth); <span class="comment">% in case of pda</span>
<span class="comment">% tolDelta in setFuncsPda used in function M2 = G.</span>

<span class="comment">% -</span>

seti = checkfield(seti,<span class="string">'tau'</span>,1.1,dispDepth);
seti = checkfield(seti,<span class="string">'useDis'</span>,1,dispDepth);

<span class="comment">% -</span>

seti = checkfield(seti,<span class="string">'nOut'</span>,30,dispDepth);
</pre><p><b>Reconstruction with primal-dual algorithm</b></p><p>For reference see</p><div><ul><li><a href="minPda.html">minPda.html</a></li><li><a href="pda.html">pda.html</a></li></ul></div><pre class="codeinput"><span class="keyword">if</span> strcmp(seti.inv,<span class="string">'pda'</span>)
    seti = checkfield(seti,<span class="string">'pdaN'</span>,50,dispDepth);
    seti = checkfield(seti,<span class="string">'pdaStepsize'</span>,<span class="string">'fix'</span>,dispDepth); <span class="comment">% pdaStepsize: fix or adaptive</span>
    seti = checkfield(seti,<span class="string">'vartheta'</span>,0.5,dispDepth); <span class="comment">% used in adaptive stepsize...</span>

    <span class="comment">% Check if the background indices are defined if seti.tF or seti.tG contains fp2</span>
    <span class="keyword">if</span> sum([strcmp(<span class="string">'fp2'</span>,seti.tF), strcmp(<span class="string">'fp2'</span>,seti.tG)]) == 1
        <span class="comment">% fp2 is used in seti.tF or seti.tG</span>
        <span class="comment">% If seti.obsMask is not defined or empty, you should use fp instead of fp2.</span>
        <span class="keyword">if</span> ~isfield(seti,<span class="string">'obsMask'</span>) || isempty(seti.obsMask) || size(unique(seti.obsMask),1) ~= 2
            disp(<span class="string">'The usage of fp2 (set background pixels to zero) instead of fp does not make sense,'</span>)
            disp(<span class="string">'because one of the following reasons:'</span>)
            disp(<span class="string">'1. seti.obsMask is not defined.'</span>)
            disp(<span class="string">'2. seti.obsMask is empty.'</span>)
            disp(<span class="string">'3. seti.obsMask is the whole ROI or nothing of ROI.'</span>)
            error(<span class="string">'You should use fp, e. g. setting seti.invNo to 6.'</span>)
        <span class="keyword">end</span>
        seti.usefp2 = 1;
    <span class="keyword">else</span>
        seti.usefp2 = 0;
    <span class="keyword">end</span>

    <span class="comment">% tolerance outside pda:</span>
    seti = checkfield(seti,<span class="string">'useTolOut'</span>,0,dispDepth);
    <span class="keyword">if</span> seti.useTolOut == 1
        seti = checkfield(seti,<span class="string">'relDisTol'</span>,0.05,dispDepth);

        <span class="keyword">if</span> ~isfield(seti,<span class="string">'pdaNmax'</span>)
            seti.pdaNmax = 250;
            setmessage(seti,<span class="string">'pdaNmax'</span>,dispDepth);
        <span class="keyword">end</span>

        <span class="keyword">if</span> isfield(seti,<span class="string">'pdaNmax'</span>)
            seti.pdaN = seti.pdaNmax;
            <span class="keyword">if</span> dispDepth &gt;= 1
                disp(<span class="string">'Because useTolIn == 1, parameter pdaN is overwritten by "pdaNmax".'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

    <span class="keyword">end</span>

    <span class="comment">% tolerance inside pda:</span>
    seti = checkfield(seti,<span class="string">'useTolIn'</span>,0,dispDepth);
    <span class="keyword">if</span> seti.useTolIn == 1
        seti = checkfield(seti,<span class="string">'ThetaStart'</span>,0.925,dispDepth);
        seti = checkfield(seti,<span class="string">'ThetaMax'</span>,0.95,dispDepth);
        seti = checkfield(seti,<span class="string">'TolGamma'</span>,0.90,dispDepth);

        <span class="keyword">if</span> ~isfield(seti,<span class="string">'pdaNmax'</span>)
            seti.pdaNmax = 250;
            setmessage(seti,<span class="string">'pdaNmax'</span>,dispDepth);
        <span class="keyword">end</span>

        <span class="keyword">if</span> isfield(seti,<span class="string">'pdaNmax'</span>)
            seti.pdaN = seti.pdaNmax;
            <span class="keyword">if</span> dispDepth &gt;= 1
                disp(<span class="string">'Because useTolIn == 1, parameter pdaN is overwritten by "pdaNmax".'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p><b>Reconstruction with shrinkage</b></p><p>Reconstruction with shrinkage is not supported in public version.</p><pre class="codeinput"><span class="keyword">if</span> strcmp(seti.inv,<span class="string">'shrinkage'</span>)
    seti = checkfield(seti,<span class="string">'stepsizeStart'</span>,1,dispDepth);
    seti = checkfield(seti,<span class="string">'useBarBor'</span>,0,dispDepth);
    seti = checkfield(seti,<span class="string">'useProjStepsize'</span>,0,dispDepth);
    seti = checkfield(seti,<span class="string">'useArmijo'</span>,0,dispDepth);
    seti = checkfield(seti,<span class="string">'maxArmijo'</span>,10,dispDepth);
<span class="keyword">end</span>
</pre><p><b>Save and load previously computed qROI</b></p><p>See <a href="recon.html">recon.html</a> for reference.</p><pre class="codeinput"><span class="keyword">if</span> isfield(seti,<span class="string">'dirname'</span>) &amp;&amp; isfield(seti,<span class="string">'fileSuffix'</span>)
    seti = checkfield(seti,<span class="string">'saveqROIcomp'</span>,sprintf(<span class="string">'%s/save_qROIcomp_iOutStop%s.mat'</span>,seti.dirname,seti.fileSuffix),dispDepth);
    <span class="comment">%in qROIsaveFile is fileSuffix important in case of varalpha (various alpha) e.g.</span>
<span class="keyword">else</span>
    <span class="keyword">if</span> dispDepth &gt;= 1
        disp(<span class="string">'   The field saveqROIcomp of structural array seti was not defined,'</span>)
        disp(<span class="string">'   because the fields dirname or/and fileSuffix are not defined.'</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>

seti = checkfield(seti,<span class="string">'loadqROIcomp'</span>,[],dispDepth); <span class="comment">% default: [], so no load...</span>
</pre><p><b>Save reconstructed contrast, ...</b></p><p>See <a href="recon.html">recon.html</a> for reference.</p><pre class="codeinput">seti = checkfield(seti,<span class="string">'savedata'</span>,0,dispDepth);
</pre><p><b>Currently unused...</b></p><p>Computes the wavelength <img src="checkConsisRec_eq00168451496784048392.png" alt="$\lambda = 2\,\pi/k$"> with wavenumber <img src="checkConsisRec_eq15636846968047188835.png" alt="$k$">.</p><pre class="codeinput">seti = checkfield(seti,<span class="string">'lambda'</span>,2*pi/seti.k,dispDepth);
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% checkConsisRec
%
% The input parameters for the variational reconstruction process 
% are checked for consistency and set or corrected whenever necessary.
%
%% Syntax
%
%   seti = checkConsisRec(seti)
%   seti = checkConsisRec(seti,dispDepth)
%
%% Description
%
% |seti = checkConsisRec(seti)| checks the existence and consistency of
% some field in structure array seti.
%
% |seti = checkConsisRec(seti,dispDepth)| does the same but allows to
% control the depth of displayed messages by |dispDepth| (0: no, 1 or greater: yes).
%
% See the section Code to get links to parameters' references.
%
%% Input Arguments
%
% * |seti|        :   struct seti
%
% *Optional Input Argument*
%
% * |dispDepth|   : Depth of displayed messages (0: no, 1 or greater: yes).
%
% *Optional Input Arguments of structure |seti|*
%
% If the fields does not exist, default values are set in this function.
%
% * |seti.useWavelet|   : Use wavelets for reconstruction (default: 0).
%                         Note that wavelets are not supported in the 
%                         public version of this code. Therefore the
%                         wavelet-specific fields |wavWeight|,
%                         |genWhiteNoiseNew|, |adaptWeightsMan|, |wavelet|,
%                         |extension|, |smin| and |samples| are not
%                         documented.
% * |seti.recname|      : What is reconstructed? A |'constrast'| (default) 
%                         or a |'source'|. Influences the title in
%                         <subplots.html>.
% * |seti.physBounds|   : Bounds for real/imaginary part of contrast: 
%                         [reMin, reMax, imMin, imMax] 
%                         (default: [-1,3,0,3])
%                         (consider also the penalty for physical bounds in
%                         <pda.html> Section "More About".)
% * |seti.tolDelta|     : Tolerance for physical bounds' delta-function
%                         (default: 1E-14) in <setFuncsPda.html>.
% * |seti.useDis|       : If it is 1 (default), the discrepancy principle
%                         is used to stop the outer iteration. (Otherwise 0).
% * |seti.nOut|         : Maximal number of outer iterations (default: 30).
%
% If the primal-dual algorithm is used (|seti.inv = 'pda')
% and the following fields does not exist, default values are set in this function.
%
% * |seti.pdaN|         : Number of inner iterations (PDA) (default: 50) (see <pda.html>).
% * |seti.pdaStepsize|  : Method to choose primal and dual stepsizes
%                         (|'fix'| (default) or |'adaptive'|)
%                         see <pdaChoosingStepsizes.html>.
% * |seti.vartheta|     : Parameter in (0,1) used in case of adaptive stepsizes,
%                         see <pdaChoosingStepsizes.html>.
% * |seti.useTolIn|     : If it is set to 1 (default: 0), the inner 
%                         tolerance principle is used to stop the inner 
%                         iterations (primal-dual algorithm), see 
%                         <minPda.html> and <minTolIn.html>.
% * |seti.useTolOut|    : If it is set to 1 (default: 0), the outer 
%                         tolerance principle is used to stop the inner 
%                         iterations, see <minPda.html>, <minTolOut.html>.
%
% In case of |seti.inv = 'pda'| and |seti.useTolIn = 1| and the following
% fields does not exist, default values are set in this function.
%
% * |seti.ThetaStart|   : (default: 0.925), see <minTolIn.html>.
% * |seti.ThetaMax|     : (default: 0.95), see <minTolIn.html>.
% * |seti.TolGamma|     : (default: 0.90), see <minTolIn.html>.
% * |seti.pdaNmax|      : Maximal iteration number, if |seti.useTolIn| or
%                         |seti.useTolOut| are 1 (default : 250).
%
% In case of |seti.inv = 'pda'| and |seti.useTolOut = 1| and the following
% fields does not exist, default values are set in this function.
%
% * |seti.relDisTol|    : Outer tolerance (default: 0.05), see <minTolOut.html>.
% * |seti.pdaNmax|      : Maximal iteration number, if |seti.useTolIn| or
%                         |seti.useTolOut| are 1 (default : 250).
%
% In case of |seti.inv = 'pda'| and the usage of |fp2| (see <setInvType.html>),
% that is not supported in the public versions it is checked if the following 
% fields exist and are not empty. Otherwise the program is stopped.
%
% * |seti.obsMask|      : Mask of pixels in ROI the assumed obstacle 
%                         (e.g. by factorization method)
%                         stored as logical vector of size seti.nROI^seti.dim x 1.
%
% The following fields should have been set in <setInvType.html>:
%
% * |seti.inv|
% * |seti.alpha|
% * |seti.beta|
% * |seti.pNorm|
% * |seti.qNorm|
% * |seti.tau|
%
% See <recon.html> for the following fields of |seti|:
%
% * |seti.saveqROIcomp|
% * |seti.loadqROIcomp|
% * |seti.savedata|
%
% Currently unused fields:
%
% * |seti.lambda|   : Wavelength (default: $\lambda = 2\pi/k$ with 
%                     wave number $k = \texttt{seti.k}$) (currently not used anywhere).
%
%% Output Argument
%
% * |seti|  : structure array, see "Optional Input Arguments of structure
% |seti|", because default values are set, if fields was not already
% defined.
%
% * |seti.usefp2|       : 1 if |fp2| is used in |seti.tF| or |seti.tG| (otherwise 0)
%                         (not supported in public version.)
%
%% See Also
% * <recon.html>
% * <minPda.html>
% * <pda.html>
%
%% Code
%
function seti = checkConsisRec(seti,dispDepth)

%%
% *setWavelet*
%
% Wavelets are not supported in public version.

seti = checkfield(seti,'useWavelet',0,dispDepth);

if seti.useWavelet == 1

    seti = checkfield(seti,'wavWeight',0,dispDepth);
    seti = checkfield(seti,'genWhiteNoiseNew',0,dispDepth);

    if seti.dim == 2
        seti = checkfield(seti,'adaptWeightsMan',1,dispDepth);
    elseif seti.dim == 3
        seti = checkfield(seti,'adaptWeightsMan',0,dispDepth);
        disp('Note: Parameter "adaptWeightsMan" = 1 is not supported in case of seti.dim = 3 yet.')
    else
        error('Dimension has to be 2 or 3, see checkConsisRec.m')
    end

    seti = checkfield(seti,'wavelet','cdf97',dispDepth);

    seti = checkfield(seti,'extension','symmetric',dispDepth); % extension: symmetric or zeropadded
    
    if ~( isfield(seti,'smin') && ...
            (seti.smin == round(seti.smin)) && (seti.smin >= 8) )
        seti.smin = 8;
        setmessage(seti,'smin',dispDepth);
    end
   
    if ~( isfield(seti,'samples') && ...
            (seti.samples == round(seti.samples)) && (seti.samples >= 1000) )
        seti.samples = 10000;
        setmessage(seti,'samples',dispDepth);
    end
    
%%
% *Example for a complete but long consistency check in case of seti.wavelet*

%     if ~( isfield(seti,'wavelet') && ...
%             ( strcmp(seti.wavelet,'cdf97') || strcmp(seti.wavelet,'haar') || strcmp(seti.wavelet,'legall53') ) )
%         seti.wavelet = 'cdf97';
%         setmessage(seti,'wavelet');
%     end

end

%%
% *Variational reconstruction process*
%
% For reference see
%
% * <recon.html>
% * <setInvType.html>
% * <pda.html>
% * <setFuncsPda.html>

seti = checkfield(seti,'inv','pda',dispDepth);
seti = checkfield(seti,'recname','contrast',dispDepth); % recname: contrast or source

% -

seti = checkfield(seti,'alpha',500,dispDepth);
seti = checkfield(seti,'beta',1E-5,dispDepth);

seti = checkfield(seti,'pNorm',2,dispDepth);
seti = checkfield(seti,'qNorm',1,dispDepth);

seti = checkfield(seti,'physBounds',[-1,3,0,3],dispDepth);

if seti.useWavelet == 1 && strcmp(seti.inv,'shrinkage')
    seti.physBounds = [-inf,inf,-inf,inf]; % no bounds for wavelet coefficients
    % in case of pda physBounds can be used in wavelet case too
    disp('Wavelets are used and shrinkage is used...');
    disp('... so set parameter "physBounds" to [-inf,inf,-inf,inf].');
end

seti = checkfield(seti,'tolDelta',1E-14,dispDepth); % in case of pda
% tolDelta in setFuncsPda used in function M2 = G.

% -

seti = checkfield(seti,'tau',1.1,dispDepth);
seti = checkfield(seti,'useDis',1,dispDepth);

% -

seti = checkfield(seti,'nOut',30,dispDepth);

%%
% *Reconstruction with primal-dual algorithm*
%
% For reference see
%
% * <minPda.html>
% * <pda.html>

if strcmp(seti.inv,'pda')
    seti = checkfield(seti,'pdaN',50,dispDepth);
    seti = checkfield(seti,'pdaStepsize','fix',dispDepth); % pdaStepsize: fix or adaptive
    seti = checkfield(seti,'vartheta',0.5,dispDepth); % used in adaptive stepsize...

    % Check if the background indices are defined if seti.tF or seti.tG contains fp2
    if sum([strcmp('fp2',seti.tF), strcmp('fp2',seti.tG)]) == 1
        % fp2 is used in seti.tF or seti.tG
        % If seti.obsMask is not defined or empty, you should use fp instead of fp2.
        if ~isfield(seti,'obsMask') || isempty(seti.obsMask) || size(unique(seti.obsMask),1) ~= 2
            disp('The usage of fp2 (set background pixels to zero) instead of fp does not make sense,')
            disp('because one of the following reasons:')
            disp('1. seti.obsMask is not defined.')
            disp('2. seti.obsMask is empty.')
            disp('3. seti.obsMask is the whole ROI or nothing of ROI.')
            error('You should use fp, e. g. setting seti.invNo to 6.')
        end
        seti.usefp2 = 1;
    else
        seti.usefp2 = 0;
    end
    
    % tolerance outside pda:
    seti = checkfield(seti,'useTolOut',0,dispDepth);
    if seti.useTolOut == 1
        seti = checkfield(seti,'relDisTol',0.05,dispDepth);
        
        if ~isfield(seti,'pdaNmax')
            seti.pdaNmax = 250;
            setmessage(seti,'pdaNmax',dispDepth);
        end

        if isfield(seti,'pdaNmax')
            seti.pdaN = seti.pdaNmax;
            if dispDepth >= 1
                disp('Because useTolIn == 1, parameter pdaN is overwritten by "pdaNmax".');
            end
        end

    end

    % tolerance inside pda:
    seti = checkfield(seti,'useTolIn',0,dispDepth);
    if seti.useTolIn == 1
        seti = checkfield(seti,'ThetaStart',0.925,dispDepth);
        seti = checkfield(seti,'ThetaMax',0.95,dispDepth);
        seti = checkfield(seti,'TolGamma',0.90,dispDepth);

        if ~isfield(seti,'pdaNmax')
            seti.pdaNmax = 250;
            setmessage(seti,'pdaNmax',dispDepth);
        end

        if isfield(seti,'pdaNmax')
            seti.pdaN = seti.pdaNmax;
            if dispDepth >= 1
                disp('Because useTolIn == 1, parameter pdaN is overwritten by "pdaNmax".');
            end
        end
    end
end

%%
% *Reconstruction with shrinkage*
%
% Reconstruction with shrinkage is not supported in public version.

if strcmp(seti.inv,'shrinkage')
    seti = checkfield(seti,'stepsizeStart',1,dispDepth);
    seti = checkfield(seti,'useBarBor',0,dispDepth);
    seti = checkfield(seti,'useProjStepsize',0,dispDepth);
    seti = checkfield(seti,'useArmijo',0,dispDepth);
    seti = checkfield(seti,'maxArmijo',10,dispDepth);
end

%%
% *Save and load previously computed qROI*
%
% See <recon.html> for reference.

if isfield(seti,'dirname') && isfield(seti,'fileSuffix')
    seti = checkfield(seti,'saveqROIcomp',sprintf('%s/save_qROIcomp_iOutStop%s.mat',seti.dirname,seti.fileSuffix),dispDepth);
    %in qROIsaveFile is fileSuffix important in case of varalpha (various alpha) e.g.
else
    if dispDepth >= 1
        disp('   The field saveqROIcomp of structural array seti was not defined,')
        disp('   because the fields dirname or/and fileSuffix are not defined.')
    end
end

seti = checkfield(seti,'loadqROIcomp',[],dispDepth); % default: [], so no load...

%%
% *Save reconstructed contrast, ...*
%
% See <recon.html> for reference.

seti = checkfield(seti,'savedata',0,dispDepth);

%%
% *Currently unused...*
%
% Computes the wavelength $\lambda = 2\,\pi/k$ with wavenumber $k$.

seti = checkfield(seti,'lambda',2*pi/seti.k,dispDepth);

end

##### SOURCE END #####
--></body></html>