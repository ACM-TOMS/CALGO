
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>setContrast</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-04-30"><meta name="DC.source" content="setContrast.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>setContrast</h1><!--introduction--><p>Set contrast function and evaluates it on CD and ROI.</p><p>Warning: This function uses feval. Be careful when using.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Syntax</a></li><li><a href="#2">Description</a></li><li><a href="#3">Example</a></li><li><a href="#4">Input Arguments</a></li><li><a href="#5">Output Arguments</a></li><li><a href="#6">More About</a></li><li><a href="#7">See Also</a></li><li><a href="#8">Code</a></li><li><a href="#9">Code: Subfunctions</a></li></ul></div><h2 id="1">Syntax</h2><pre class="language-matlab">seti = setContrast(seti)
seti = setContrast(seti,dispDepth)
seti = setContrast(seti,dispDepth,out)
</pre><h2 id="2">Description</h2><p><tt>seti = setContrast(seti)</tt> sets the contrast defined in <tt>seti.contrast</tt> on the computational domain (CD) and the region of interest (ROI) and stores them as vectors in <tt>seti.qCDexact</tt> and <tt>seti.qROIexact</tt>.</p><p><tt>seti = setContrast(seti,dispDepth)</tt> does the same but allows to control displayed messages by <tt>dispDepth</tt>.</p><pre class="codeinput"><span class="comment">% |seti = setiContrast(seti,dispDepth,out)| does the same but deals with the output</span>
<span class="comment">% depth |out|: no figure (0), plot figure (1), plot and save figure (2).</span>
<span class="comment">%</span>
<span class="comment">% * If |seti.rotation| contains a value, the contrast is rotated around</span>
<span class="comment">%   this number in degrees in mathematical positive sense.</span>
<span class="comment">%</span>
<span class="comment">% *Structure of the program*</span>
<span class="comment">%</span>
<span class="comment">% * Checks consistency of the field contrasts, i.e. essentially sets a</span>
<span class="comment">%   valid seti.contrast (name of file in folder incontrasts).</span>
<span class="comment">%</span>
<span class="comment">% - If no real-world (experimentally measured) data is used (|expData| is empty) and no</span>
<span class="comment">% contrast is defined, set default contrasts in dependence of dimension</span>
<span class="comment">% (|seti.dim|).</span>
<span class="comment">%</span>
<span class="comment">% - If no real-world data is used and the contrast is</span>
<span class="comment">% |referenceBall|, choose automatically referenceBall2D or referenceBall3D</span>
<span class="comment">% in dependence of the choosen dimension (seti.dim).</span>
<span class="comment">%</span>
<span class="comment">% * Deals with real-world data (if seti.expData = 'fresnel')</span>
<span class="comment">%</span>
<span class="comment">% - If |seti.fresnelFile| contains "dielTM"</span>
<span class="comment">%   choose |seti.contrast = 'fresnel_op1_dielTM'|.</span>
<span class="comment">%</span>
<span class="comment">% - If |seti.fresnelFile| contains "twodielTM"</span>
<span class="comment">%   choose |seti.contrast = 'fresnel_op1_twodielTM'|.</span>
<span class="comment">%</span>
<span class="comment">% - If |seti.fresnelFile| contains "rectTM_cent"</span>
<span class="comment">%   choose |seti.contrast = 'fresnel_op1_rectTM_cent'|.</span>
<span class="comment">%</span>
<span class="comment">% * Rotate grid to rotate the contrast.</span>
<span class="comment">%</span>
<span class="comment">% * Evalutes the predefined contrast in CD and ROI.</span>
<span class="comment">%</span>
<span class="comment">% * Restricts the contrast:</span>
<span class="comment">%   Contrast has to be restricted to B(0,rCD/2) which is seti.ballMask</span>
<span class="comment">%   (seti.ROImask is rectangular with length rCD/2).</span>
<span class="comment">%</span>
<span class="comment">% * Saves the contrast as a vector (in ROI and CD).</span>
<span class="comment">%</span>
<span class="comment">% * Plots the predefined contrast, see &lt;plotPredefinedContrast.html&gt;, if</span>
<span class="comment">% |out| was set to 1 or 2. In case of |out| = 2 the plot is additionally</span>
<span class="comment">% saved.</span>
<span class="comment">%</span>
</pre><h2 id="3">Example</h2><pre class="language-matlab">init;
seti.dim = 2;                           <span class="comment">% dimension of the problem</span>
seti = setGrid(seti);                   <span class="comment">% set grids CD and ROI</span>
seti.contrast = <span class="string">'cornerBallSparse2D'</span>;   <span class="comment">% predefined contrast</span>
seti.rotation = 20;                     <span class="comment">% rotate the contrast 20 degrees</span>
</pre><pre class="language-matlab">seti.plotVisible = <span class="string">'on'</span>;                <span class="comment">% required in plotPredefinedContrast</span>
seti.usecbarlim = 0;                    <span class="comment">% required in plotPredefinedContrast</span>
seti.plotPublish = 0;                   <span class="comment">% required in plotPredefinedContrast</span>
</pre><pre class="language-matlab">seti = setReshapeVecMat(seti);          <span class="comment">% definition of seti.G is required</span>
seti = setContrast(seti,1,1);
</pre><h2 id="4">Input Arguments</h2><div><ul><li>seti    :   structure array</li></ul></div><div><ul><li><tt>seti.contrast</tt>   :   name of predefined contrast function</li><li><tt>seti.rotation</tt>   :   mathematical positive rotation of the contrast in degrees (only in 2D).                         (If the field rotation does not exist, no rotation                         is done.)</li></ul></div><p><b>Optional Input Arguments</b></p><div><ul><li><tt>dispDepth</tt>   : Depth of displayed messages (0: no, 1 or greater: yes).</li><li><tt>out</tt>         : output depth: no figure (0), plot figure (1),                   plot and save figure (2).</li></ul></div><h2 id="5">Output Arguments</h2><div><ul><li><tt>seti.qCDexact</tt>     :   predefined contrast evalutated on CD                           (computational domain)                           (as vector of size seti.nCD^seti.dim x 1).</li><li><tt>seti.qROIexact</tt>    :   predefined contrast evalutated on ROI                           (region of interest)                           (as vector of size seti.nROI^seti.dim x 1).</li></ul></div><h2 id="6">More About</h2><div><ul><li>Contrasts are defined in the folder "incontrasts". To use the   corresponding contrast it is sufficient to write the name of the   function in <tt>seti.contrast</tt> (a file path is not necessary).</li><li>A list of all predefined contrasts is available in <a href="incontrastsRef.html">incontrastsRef.html</a>.</li><li>IPscatt only uses the contrast evaluated on ROI. If you use <tt>seti.qCDexact</tt> and your own predefined contrasts, note the following: The predefined contrasts are defined on ROI via the scaling factor <tt>R = seti.rCD/2</tt>. (To be exactly, the mathematical sensible region is the open circle with radius <tt>seti.rCD/2</tt> and for sake of simplicity the region of interest is the biggest square inside this mathematical sensible region.) This function provides the contrasts' evaluation on CD too. If you want to use it and you use your own predefined contrast, make sure that your contrast vanishes outside the open ball of radius rCD/2.</li></ul></div><h2 id="7">See Also</h2><div><ul><li><a href="setGrid.html">setGrid.html</a></li><li><a href="plotPredefinedContrast.html">plotPredefinedContrast.html</a></li><li><a href="incontrastsRef.html">incontrastsRef.html</a></li></ul></div><h2 id="8">Code</h2><pre class="codeinput"><span class="keyword">function</span> seti = setContrast(seti,varargin)

<span class="keyword">if</span> nargin == 2
    dispDepth = varargin{1};
    out = 0;
<span class="keyword">elseif</span> nargin == 3
    dispDepth = varargin{1};
    out = varargin{2};
<span class="keyword">else</span>
    dispDepth = 0;
    out = 0;
<span class="keyword">end</span>

<span class="comment">% Check consistency</span>
seti = contrastConsis(seti,dispDepth);

<span class="comment">% Deal with real-world data: choose the corresponding contrast</span>
<span class="keyword">if</span> isfield(seti,<span class="string">'expData'</span>)
    seti = dealWithExpData(seti,dispDepth);
<span class="keyword">end</span>

<span class="comment">% Rotate grid to rotate the contrast</span>
[gridRot, gridRotROI] = rotateGrid(seti);
seti = evalContrast(gridRot,gridRotROI,seti);

<span class="comment">% Contrast has to be restricted to B(0,rCD/2) which is seti.ballMask</span>
<span class="comment">% (seti.ROImask is rectangular with length rCD/2)</span>
seti = restrictContrast(seti);

<span class="comment">% Save contrast as a vector</span>
seti.qCDexact = seti.qCDexact(:);
seti.qROIexact = seti.qROIexact(:);

<span class="comment">% Plot predefined contrast</span>
<span class="keyword">if</span> out &gt;= 1
    plotPredefinedContrast(seti,out);
<span class="keyword">end</span>

<span class="keyword">end</span>
</pre><h2 id="9">Code: Subfunctions</h2><p><b>Code: subfunction: contrastConsis</b></p><p>Check consistency of seti.contrast.</p><pre class="codeinput"><span class="keyword">function</span> seti = contrastConsis(seti,dispDepth)
<span class="keyword">if</span> ~isfield(seti,<span class="string">'expData'</span>) &amp;&amp; ~isfield(seti,<span class="string">'contrast'</span>)
    <span class="keyword">if</span> seti.dim == 2
        seti.contrast = <span class="string">'cornerBallSparse2D'</span>;
    <span class="keyword">elseif</span> seti.dim == 3
        seti.contrast = <span class="string">'cross3D'</span>;
    <span class="keyword">end</span>
    setmessage(seti,<span class="string">'contrast'</span>,dispDepth);
<span class="keyword">end</span>

<span class="keyword">if</span> ~isfield(seti,<span class="string">'expData'</span>) &amp;&amp; (strcmp(seti.contrast,<span class="string">'referenceBall'</span>))
    <span class="keyword">if</span> seti.dim == 2
        seti.contrast = <span class="string">'referenceBall2D'</span>;
    <span class="keyword">else</span>
        seti.contrast = <span class="string">'referenceBall3D'</span>;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">end</span>
</pre><p><b>Code: subfunction: dealWithExpData</b></p><p>Deals with real-world data: sets the corresponding predefined contrast in case of Insitute's Fresnel data if predefined contrast is available.</p><pre class="codeinput"><span class="keyword">function</span> seti = dealWithExpData(seti,dispDepth)
<span class="keyword">if</span> strcmp(seti.expData,<span class="string">'fresnel'</span>)
</pre><p><b>---- expData: Fresnel</b></p><pre class="codeinput">    filename = seti.fresnelFile;
    <span class="keyword">if</span> regexpi(filename,<span class="string">'/dielTM'</span>) &gt; 0
        seti.contrast = <span class="string">'fresnel_op1_dielTM'</span>;
        <span class="keyword">if</span> dispDepth &gt;= 1
            fprintf(<span class="string">'   Using %s as exact contrast.\n'</span>,seti.contrast);
        <span class="keyword">end</span>
    <span class="keyword">elseif</span> regexpi(filename,<span class="string">'/twodielTM'</span>) &gt; 0
        seti.contrast = <span class="string">'fresnel_op1_twodielTM'</span>;
        <span class="keyword">if</span> dispDepth &gt;= 1
            fprintf(<span class="string">'   Using %s as exact contrast.\n'</span>,seti.contrast);
        <span class="keyword">end</span>
    <span class="keyword">elseif</span> regexpi(filename,<span class="string">'/rectTM_cent'</span>) &gt; 0
        seti.contrast = <span class="string">'fresnel_op1_rectTM_cent'</span>;
        <span class="keyword">if</span> dispDepth &gt;= 1
            fprintf(<span class="string">'   Using %s as exact contrast.\n'</span>,seti.contrast);
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        disp(<span class="string">'No exact contrast implemented for this data yet.'</span>)
        <span class="comment">%error('op. 1: rectTM_cent, rectTM_dece, recttTR and uTM not implemented yet; op. 2 too...');</span>
        disp(<span class="string">'setting contrast to zero because seti.contrast == "fresnel"'</span>);
        seti.qCDexact = zeros(seti.nCD^seti.dim,1); <span class="comment">% no exact contrast available on CD</span>
        seti.qROIexact = zeros(seti.nROI^seti.dim,1); <span class="comment">% no exact contrast available on ROI</span>
        <span class="keyword">return</span>;
    <span class="keyword">end</span>
</pre><p><b>---- expData: Simonetti (out of order...)</b></p><pre class="codeinput"><span class="comment">%     elseif strcmp(seti.expData,'simonetti')</span>
<span class="comment">%         if isfield(seti,'contrast')</span>
<span class="comment">%             seti.qCDexact = feval(seti.contrast, seti.grid(1,:), seti.grid(2,:), seti);</span>
<span class="comment">%             seti.qROIexact = feval(seti.contrast, seti.gridROI(1,:), seti.gridROI(2,:), seti);</span>
<span class="comment">%             seti.qCDexact = seti.qCDexact(:);</span>
<span class="comment">%             seti.qROIexact = seti.qROIexact(:);</span>
<span class="comment">%         end</span>

<span class="comment">%    else</span>
<span class="comment">%        error('seti.expData is not implemented in setContrast');</span>
</pre><pre class="codeinput"><span class="keyword">end</span>

<span class="keyword">end</span>
</pre><p><b>Code: subfunction: rotateGrid</b></p><p>Rotation of grid to rotate the contrast (in 2D).</p><p>The contrast is usually evalutated on seti.grid (CD) respectively seti.gridROI (ROI). But we will evaluate it on rotated grid to rotate the contrast.</p><p>Feature in future: rotation in 3D case. Make sure to adapt the slice through the object then too.</p><pre class="codeinput"><span class="keyword">function</span> [gridRot, gridRotROI] = rotateGrid(seti)

<span class="keyword">if</span> seti.dim == 2 &amp;&amp; isfield(seti,<span class="string">'rotation'</span>) &amp;&amp; seti.rotation ~= 0

    <span class="comment">% Rotation matrix in R^2</span>
    R = @(alpha) [cos(alpha), -sin(alpha); sin(alpha), cos(alpha)];

    <span class="comment">% Compute alpha in rad and set minus</span>
    <span class="comment">% such that seti.rotation is mathematical positive rotation in degrees.</span>
    alpha = -seti.rotation/360*2*pi;

    gridRot = R(alpha)*seti.grid;
    gridRotROI = R(alpha)*seti.gridROI;
<span class="keyword">else</span>
    gridRot = seti.grid;
    gridRotROI = seti.gridROI;
<span class="keyword">end</span>

<span class="keyword">end</span>
</pre><p><b>Code: subfunction: evalContrast</b></p><p>Evaluate the contrast in grid respectively the rotated grid.</p><pre class="codeinput"><span class="keyword">function</span> seti = evalContrast(gridRot,gridRotROI,seti)
<span class="comment">% Make sure that a file exists and that the path to the file contains the string /incontrasts/.</span>
<span class="comment">% For Windows we look for the string \incontrasts\.</span>
<span class="keyword">if</span> exist(seti.contrast,<span class="string">'file'</span>) == 2 &amp;&amp; <span class="keyword">...</span>
        ( ~isempty(regexp(which(seti.contrast),<span class="string">'/incontrasts/'</span>,<span class="string">'once'</span>)) || ~isempty(regexp(which(seti.contrast),<span class="string">'\incontrasts\'</span>,<span class="string">'once'</span>)) )
    <span class="keyword">switch</span> seti.dim
        <span class="keyword">case</span> 2
            seti.qCDexact = feval(seti.contrast, gridRot(1,:), gridRot(2,:), seti);
            seti.qROIexact = feval(seti.contrast, gridRotROI(1,:), gridRotROI(2,:), seti);
        <span class="keyword">case</span> 3
            seti.qCDexact = feval(seti.contrast, gridRot(1,:), gridRot(2,:), gridRot(3,:), seti);
            seti.qROIexact = feval(seti.contrast, gridRotROI(1,:), gridRotROI(2,:), gridRotROI(3,:), seti);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    fprintf(<span class="string">'Error: %s is not a file in the folder /incontrasts/ or its subfolders.\n'</span>,seti.contrast);
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p><b>Code: subfunction: restrictContrast</b></p><p>Restrict contrast</p><div><ul><li>on ballMask in case of CD and</li><li>on ballMaskROI in case of ROI.</li></ul></div><p>Contrast has to be restricted to B(0,rCD/2) which is seti.ballMask (seti.ROImask is rectangular with length rCD/2).</p><p>Note that the anisotropic case is not supported in the public version.</p><pre class="codeinput"><span class="keyword">function</span> seti = restrictContrast(seti)

<span class="comment">% if... else...: distinguish anisotropic and not anisotropic contrast</span>
<span class="keyword">if</span> numel(seti.qCDexact) == seti.nCD^seti.dim
</pre><p>No anisotropic contrast</p><pre class="codeinput">    <span class="keyword">if</span> norm(seti.qCDexact(:)-seti.qCDexact(:).*seti.ballMask(:))&gt;1e-10
        seti.qCDexact = seti.qCDexact(:).*seti.ballMask(:);
        seti.qROIexact = seti.qROIexact(:).*seti.ballMaskROI(:);
        disp(<span class="string">'Warning - contrast has been restricted to B(0,rCD/2)'</span>);
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">else</span>
</pre><p>Anisotropic contrast (not supported in public version)</p><pre class="codeinput">    disp(<span class="string">'Note: Detected anisotropic contrast.'</span>);

    <span class="keyword">if</span> norm(seti.qCDexact(:,1)-seti.qCDexact(:,1).*seti.ballMask(:))&gt;1e-10
        seti.qCDexact(:,1) = seti.qCDexact(:,1).*seti.ballMask(:);
        seti.qROIexact(:,1) = seti.qROIexact(:,1).*seti.ballMaskROI(:);
        disp(<span class="string">'Warning - contrast has been restricted to B(0,rCD/2)'</span>);
    <span class="keyword">end</span>

    <span class="keyword">if</span> norm(seti.qCDexact(:,2)-seti.qCDexact(:,2).*seti.ballMask(:))&gt;1e-10
        seti.qCDexact(:,2) = seti.qCDexact(:,2).*seti.ballMask(:);
        seti.qROIexact(:,2) = seti.qROIexact(:,2).*seti.ballMaskROI(:);
        disp(<span class="string">'Warning - contrast has been restricted to B(0,rCD/2)'</span>);
    <span class="keyword">end</span>

    <span class="keyword">if</span> norm(seti.qCDexact(:,3)-seti.qCDexact(:,3).*seti.ballMask(:))&gt;1e-10
        seti.qCDexact(:,3) = seti.qCDexact(:,3).*seti.ballMask(:);
        seti.qROIexact(:,3) = seti.qROIexact(:,3).*seti.ballMaskROI(:);
        disp(<span class="string">'Warning - contrast has been restricted to B(0,rCD/2)'</span>);
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>

<span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% setContrast
% Set contrast function and evaluates it on CD and ROI.
%
% Warning: This function uses feval. Be careful when using.
%
%% Syntax
%
%   seti = setContrast(seti)
%   seti = setContrast(seti,dispDepth)
%   seti = setContrast(seti,dispDepth,out)
%
%% Description
% |seti = setContrast(seti)| sets the contrast defined in |seti.contrast|
% on the computational domain (CD) and the region of interest (ROI) and
% stores them as vectors in |seti.qCDexact| and |seti.qROIexact|.
%
% |seti = setContrast(seti,dispDepth)| does the same but allows to control
% displayed messages by |dispDepth|.

% |seti = setiContrast(seti,dispDepth,out)| does the same but deals with the output 
% depth |out|: no figure (0), plot figure (1), plot and save figure (2).
%
% * If |seti.rotation| contains a value, the contrast is rotated around
%   this number in degrees in mathematical positive sense.
%
% *Structure of the program*
%
% * Checks consistency of the field contrasts, i.e. essentially sets a 
%   valid seti.contrast (name of file in folder incontrasts).
%
% - If no real-world (experimentally measured) data is used (|expData| is empty) and no
% contrast is defined, set default contrasts in dependence of dimension
% (|seti.dim|).
%
% - If no real-world data is used and the contrast is
% |referenceBall|, choose automatically referenceBall2D or referenceBall3D 
% in dependence of the choosen dimension (seti.dim).
%
% * Deals with real-world data (if seti.expData = 'fresnel')
%
% - If |seti.fresnelFile| contains "dielTM" 
%   choose |seti.contrast = 'fresnel_op1_dielTM'|.
%
% - If |seti.fresnelFile| contains "twodielTM"
%   choose |seti.contrast = 'fresnel_op1_twodielTM'|.
%
% - If |seti.fresnelFile| contains "rectTM_cent"
%   choose |seti.contrast = 'fresnel_op1_rectTM_cent'|.
%
% * Rotate grid to rotate the contrast.
%
% * Evalutes the predefined contrast in CD and ROI.
%
% * Restricts the contrast:
%   Contrast has to be restricted to B(0,rCD/2) which is seti.ballMask
%   (seti.ROImask is rectangular with length rCD/2).
%
% * Saves the contrast as a vector (in ROI and CD).
%
% * Plots the predefined contrast, see <plotPredefinedContrast.html>, if
% |out| was set to 1 or 2. In case of |out| = 2 the plot is additionally
% saved.
%
%% Example
%
%   init;
%   seti.dim = 2;                           % dimension of the problem
%   seti = setGrid(seti);                   % set grids CD and ROI
%   seti.contrast = 'cornerBallSparse2D';   % predefined contrast
%   seti.rotation = 20;                     % rotate the contrast 20 degrees
%
%   seti.plotVisible = 'on';                % required in plotPredefinedContrast
%   seti.usecbarlim = 0;                    % required in plotPredefinedContrast
%   seti.plotPublish = 0;                   % required in plotPredefinedContrast
%
%   seti = setReshapeVecMat(seti);          % definition of seti.G is required
%   seti = setContrast(seti,1,1);
%
%% Input Arguments
%
% * seti    :   structure array
% 
% * |seti.contrast|   :   name of predefined contrast function
% * |seti.rotation|   :   mathematical positive rotation of the contrast in degrees (only in 2D).
%                         (If the field rotation does not exist, no rotation
%                         is done.)
%
% *Optional Input Arguments*
%
% * |dispDepth|   : Depth of displayed messages (0: no, 1 or greater: yes).
% * |out|         : output depth: no figure (0), plot figure (1), 
%                   plot and save figure (2).
%
%% Output Arguments
%
% * |seti.qCDexact|     :   predefined contrast evalutated on CD
%                           (computational domain) 
%                           (as vector of size seti.nCD^seti.dim x 1).
% * |seti.qROIexact|    :   predefined contrast evalutated on ROI
%                           (region of interest) 
%                           (as vector of size seti.nROI^seti.dim x 1).
%
%% More About
%
% * Contrasts are defined in the folder "incontrasts". To use the 
%   corresponding contrast it is sufficient to write the name of the 
%   function in |seti.contrast| (a file path is not necessary).
% * A list of all predefined contrasts is available in
% <incontrastsRef.html>.
% * IPscatt only uses the contrast evaluated on ROI. 
% If you use |seti.qCDexact| and your own predefined contrasts, note the following:
% The predefined contrasts are defined on ROI via the scaling factor |R = seti.rCD/2|.
% (To be exactly, the mathematical sensible region is the open circle with radius
% |seti.rCD/2| and for sake of simplicity the region of interest is the 
% biggest square inside this mathematical sensible region.) This function
% provides the contrasts' evaluation on CD too. If you want to use it and
% you use your own predefined contrast, make sure that your contrast
% vanishes outside the open ball of radius rCD/2.
%
%% See Also
% * <setGrid.html>
% * <plotPredefinedContrast.html>
% * <incontrastsRef.html>
%
%% Code
%
function seti = setContrast(seti,varargin)

if nargin == 2
    dispDepth = varargin{1};
    out = 0;
elseif nargin == 3
    dispDepth = varargin{1};
    out = varargin{2};
else
    dispDepth = 0;
    out = 0;
end

% Check consistency
seti = contrastConsis(seti,dispDepth);

% Deal with real-world data: choose the corresponding contrast
if isfield(seti,'expData')
    seti = dealWithExpData(seti,dispDepth);
end

% Rotate grid to rotate the contrast
[gridRot, gridRotROI] = rotateGrid(seti);
seti = evalContrast(gridRot,gridRotROI,seti);

% Contrast has to be restricted to B(0,rCD/2) which is seti.ballMask
% (seti.ROImask is rectangular with length rCD/2)
seti = restrictContrast(seti);

% Save contrast as a vector
seti.qCDexact = seti.qCDexact(:);
seti.qROIexact = seti.qROIexact(:);

% Plot predefined contrast
if out >= 1
    plotPredefinedContrast(seti,out);
end

end

%% Code: Subfunctions

%%
% *Code: subfunction: contrastConsis*
%
% Check consistency of seti.contrast.

function seti = contrastConsis(seti,dispDepth)
if ~isfield(seti,'expData') && ~isfield(seti,'contrast')
    if seti.dim == 2
        seti.contrast = 'cornerBallSparse2D';
    elseif seti.dim == 3
        seti.contrast = 'cross3D';
    end
    setmessage(seti,'contrast',dispDepth);
end

if ~isfield(seti,'expData') && (strcmp(seti.contrast,'referenceBall'))
    if seti.dim == 2
        seti.contrast = 'referenceBall2D';
    else
        seti.contrast = 'referenceBall3D';
    end
end

end

%%
% *Code: subfunction: dealWithExpData*
%
% Deals with real-world data: sets the corresponding predefined
% contrast in case of Insitute's Fresnel data if predefined contrast is available.
%
function seti = dealWithExpData(seti,dispDepth)
if strcmp(seti.expData,'fresnel')
    %%
    % *REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH expData: Fresnel*
    
    filename = seti.fresnelFile;
    if regexpi(filename,'/dielTM') > 0
        seti.contrast = 'fresnel_op1_dielTM';
        if dispDepth >= 1
            fprintf('   Using %s as exact contrast.\n',seti.contrast);
        end
    elseif regexpi(filename,'/twodielTM') > 0
        seti.contrast = 'fresnel_op1_twodielTM';
        if dispDepth >= 1
            fprintf('   Using %s as exact contrast.\n',seti.contrast);
        end
    elseif regexpi(filename,'/rectTM_cent') > 0
        seti.contrast = 'fresnel_op1_rectTM_cent';
        if dispDepth >= 1
            fprintf('   Using %s as exact contrast.\n',seti.contrast);
        end
    else
        disp('No exact contrast implemented for this data yet.')
        %error('op. 1: rectTM_cent, rectTM_dece, recttTR and uTM not implemented yet; op. 2 too...');
        disp('setting contrast to zero because seti.contrast == "fresnel"');
        seti.qCDexact = zeros(seti.nCD^seti.dim,1); % no exact contrast available on CD
        seti.qROIexact = zeros(seti.nROI^seti.dim,1); % no exact contrast available on ROI
        return;
    end
    %% 
    % *REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH expData: Simonetti (out of order...)*
    
%     elseif strcmp(seti.expData,'simonetti')
%         if isfield(seti,'contrast')
%             seti.qCDexact = feval(seti.contrast, seti.grid(1,:), seti.grid(2,:), seti);
%             seti.qROIexact = feval(seti.contrast, seti.gridROI(1,:), seti.gridROI(2,:), seti);
%             seti.qCDexact = seti.qCDexact(:);
%             seti.qROIexact = seti.qROIexact(:);
%         end

%    else
%        error('seti.expData is not implemented in setContrast');
end

end

%%
% *Code: subfunction: rotateGrid*
%
% Rotation of grid to rotate the contrast (in 2D).
%
% The contrast is usually evalutated on seti.grid (CD) respectively
% seti.gridROI (ROI). 
% But we will evaluate it on rotated grid to rotate the contrast.
%
% Feature in future: rotation in 3D case. Make sure to adapt the slice
% through the object then too.

function [gridRot, gridRotROI] = rotateGrid(seti)

if seti.dim == 2 && isfield(seti,'rotation') && seti.rotation ~= 0
  
    % Rotation matrix in R^2
    R = @(alpha) [cos(alpha), -sin(alpha); sin(alpha), cos(alpha)];

    % Compute alpha in rad and set minus
    % such that seti.rotation is mathematical positive rotation in degrees.
    alpha = -seti.rotation/360*2*pi;

    gridRot = R(alpha)*seti.grid;
    gridRotROI = R(alpha)*seti.gridROI;
else
    gridRot = seti.grid;
    gridRotROI = seti.gridROI;
end

end

%%
% *Code: subfunction: evalContrast*
%
% Evaluate the contrast in grid respectively the rotated grid.

function seti = evalContrast(gridRot,gridRotROI,seti)
% Make sure that a file exists and that the path to the file contains the string /incontrasts/.
% For Windows we look for the string \incontrasts\.
if exist(seti.contrast,'file') == 2 && ...
        ( ~isempty(regexp(which(seti.contrast),'/incontrasts/','once')) || ~isempty(regexp(which(seti.contrast),'\incontrasts\','once')) )
    switch seti.dim
        case 2
            seti.qCDexact = feval(seti.contrast, gridRot(1,:), gridRot(2,:), seti);
            seti.qROIexact = feval(seti.contrast, gridRotROI(1,:), gridRotROI(2,:), seti);
        case 3
            seti.qCDexact = feval(seti.contrast, gridRot(1,:), gridRot(2,:), gridRot(3,:), seti);
            seti.qROIexact = feval(seti.contrast, gridRotROI(1,:), gridRotROI(2,:), gridRotROI(3,:), seti);
    end
else
    fprintf('Error: %s is not a file in the folder /incontrasts/ or its subfolders.\n',seti.contrast);
end
end

%%
% *Code: subfunction: restrictContrast*
%
% Restrict contrast
%
% * on ballMask in case of CD and 
% * on ballMaskROI in case of ROI.
%
% Contrast has to be restricted to B(0,rCD/2) which is seti.ballMask
% (seti.ROImask is rectangular with length rCD/2).
%
% Note that the anisotropic case is not supported in the public version.
%
function seti = restrictContrast(seti)

% if... else...: distinguish anisotropic and not anisotropic contrast
if numel(seti.qCDexact) == seti.nCD^seti.dim
    %%
    % No anisotropic contrast
    if norm(seti.qCDexact(:)-seti.qCDexact(:).*seti.ballMask(:))>1e-10
        seti.qCDexact = seti.qCDexact(:).*seti.ballMask(:);
        seti.qROIexact = seti.qROIexact(:).*seti.ballMaskROI(:);
        disp('Warning - contrast has been restricted to B(0,rCD/2)');
    end
else
    %%
    % Anisotropic contrast (not supported in public version)
    disp('Note: Detected anisotropic contrast.');
    
    if norm(seti.qCDexact(:,1)-seti.qCDexact(:,1).*seti.ballMask(:))>1e-10
        seti.qCDexact(:,1) = seti.qCDexact(:,1).*seti.ballMask(:);
        seti.qROIexact(:,1) = seti.qROIexact(:,1).*seti.ballMaskROI(:);
        disp('Warning - contrast has been restricted to B(0,rCD/2)');
    end
    
    if norm(seti.qCDexact(:,2)-seti.qCDexact(:,2).*seti.ballMask(:))>1e-10
        seti.qCDexact(:,2) = seti.qCDexact(:,2).*seti.ballMask(:);
        seti.qROIexact(:,2) = seti.qROIexact(:,2).*seti.ballMaskROI(:);
        disp('Warning - contrast has been restricted to B(0,rCD/2)');
    end
    
    if norm(seti.qCDexact(:,3)-seti.qCDexact(:,3).*seti.ballMask(:))>1e-10
        seti.qCDexact(:,3) = seti.qCDexact(:,3).*seti.ballMask(:);
        seti.qROIexact(:,3) = seti.qROIexact(:,3).*seti.ballMaskROI(:);
        disp('Warning - contrast has been restricted to B(0,rCD/2)');
    end
end

end

##### SOURCE END #####
--></body></html>