
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>setData</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-04-30"><meta name="DC.source" content="setData.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>setData</h1><!--introduction--><p>Sets geometry and experimental set-up, simulates the scattered field and computes noisy data (or loads real-world data).</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Syntax</a></li><li><a href="#2">Description</a></li><li><a href="#3">Example</a></li><li><a href="#4">Input Arguments</a></li><li><a href="#5">Output Arguments</a></li><li><a href="#6">References</a></li><li><a href="#7">See Also</a></li><li><a href="#8">Code: setData</a></li></ul></div><h2 id="1">Syntax</h2><pre class="language-matlab">seti = setData(seti)
seti = setData(seti,dispDepth)
seti = setData(seti,dispDepth,out)
</pre><h2 id="2">Description</h2><p><tt>seti = setData(seti)</tt> essentially sets the grids (seti.grid and seti.gridROI) as well as the transmitters and receivers positions (seti.incPnts and seti.measPnts), simulates the scattered field (seti.FmeasExact) and computes noisy data (seti.FmeasDelta) (or loads real-world data).</p><p><tt>seti = setData(seti,dispDepth)</tt> does the same as <tt>seti = setData(seti)</tt> but allows to control the depth of displayed messages by <tt>dispDepth</tt>.</p><p><tt>seti = setData(seti,dispDepth,out)</tt> does the same as <tt>seti = setData(seti,dispDepth)</tt> in case of <tt>out = 0</tt>, but plots the figures in case of <tt>out = 1</tt> and additionally saves them in case of <tt>out = 2</tt>.</p><div><ul><li>If <tt>seti.expData = 'fresnel'</tt> real-world data from Institute Fresnel are loaded (see <a href="loadData.html">loadData.html</a>), i.e. the measurements of the incident fields and total fields are loaded, the corresponding geometry and simulation is done, and the incident field is matched.</li></ul></div><div><ul><li>If <tt>seti.loadFmeas</tt> contains a path, <tt>FmeasExact</tt> and <tt>FmeasDelta</tt> are loaded.</li><li>Note that <tt>FmeasDelta</tt> is only used if <tt>seti.useFmeasDelta</tt> was set to 1 (otherwise data with noise is generated again).</li></ul></div><div><ul><li>If no field <tt>expData</tt> of <tt>seti</tt> exists and <tt>out</tt> equals 2, the exact and simulated data <tt>seti.FmeasExact</tt> and <tt>seti.FmeasDelta</tt> are saved as <tt>FmeasExact</tt> and <tt>FmeasDelta</tt> in a file <tt>save_Fmeas.mat</tt>. (Exactly this file can be loaded by <tt>seti.loadFmeas</tt>.)</li></ul></div><p><b>Structure of the function</b></p><div><ul><li>The set of geometry and simulation (see <a href="setGeomSim.html">setGeomSim.html</a>) essentially sets general settings for figures, the grids (computational domain (CD) and region of interest (ROI)), the kernel, the experimental set-up, and the predefined contrast.</li><li>The the scattered field is simulated by <a href="mimo.html">mimo.html</a>.</li><li>Noise is added by <a href="addNoise.html">addNoise.html</a>.</li></ul></div><h2 id="3">Example</h2><p><b>Example 1</b></p><pre>init;                    % initialization
seti = struct;           % create empty structural array
seti = setData(seti);    % compute but do not plot or store figures</pre><p><b>Example 2</b></p><pre>init;
seti = struct;
seti = setData(seti,4);  % display output messages</pre><p><b>Example 3</b></p><pre>init;
setInput;   % set input and make directories for output
seti = setData(seti,4,2);    % display output messages; plot and save files and figures</pre><h2 id="4">Input Arguments</h2><p>For a description of the following input arguments see <a href="setInput.html">setInput.html</a>.</p><div><ul><li><tt>inseti</tt></li><li><tt>seti</tt></li><li><tt>usevaralpha</tt></li><li><tt>usevarbeta</tt></li><li><tt>usevardelta</tt></li><li><tt>usevartol</tt></li></ul></div><p>Note that many of the output arguments can by set in the struct seti as input arguments. This fields are marked by "Can be set by user (otherwise default is set)".</p><p>We only mention explictly the input arguments to deal with experimentally measured data from Institute Fresnel.</p><div><ul><li>seti.expData    :   Set 'fresnel' to load real-world data                       (experimentally measured) from Institute Fresnel.</li></ul></div><p><b>The following parameters can be set by user only in case of  seti.expData = 'fresnel'</b></p><p>For further details see <a href="loadData.html">loadData.html</a> and <a href="matchIncField.html">matchIncField.html</a>.</p><div><ul><li>seti.fresnelFreq    :   frequency of Fresnel data set in Hz                           (default: 5e+09)</li><li>seti.fresnelFile    :   path to real-world data                           (default:                           'inexpdata/fresnel_opus_1/twodielTM_8f.exp')                           (Make sure to use data with <tt>TM</tt> in the filemname,                           which stands for transverse magnetic (TM)                           polarization, because the Helmholtz equation                           only models electromagnetic waves in the TM                           case, see Section 2 in [1].)</li><li>seti.nuMax          :   match incident field parameter (default: 7)</li><li>seti.ampCalc        :   method to compute the coefficients c (1, 2 or 3),                           we recommend to use method 1.</li></ul></div><p><b>Optional Input Argument</b></p><div><ul><li>dispDepth     : depth of displayed messages in dependence of <tt>dispDepth</tt> (number between 0 and 5).</li><li>out           : output depth: no figure (0), plot figure (1),                   plot and save figure (2).</li></ul></div><h2 id="5">Output Arguments</h2><div><ul><li>seti    :   structure array</li></ul></div><p>For the following output arguments see <a href="setGeomSim.html">setGeomSim.html</a>:</p><div><ul><li>seti.tol</li></ul></div><p>For the following output arguments see Subfunction <tt>setFigureSettings</tt> in <a href="setGeomSim.html">setGeomSim.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.plotFreq       :   default: 1</li><li>seti.usecbarlim     :   default: 1</li><li>seti.cbarlim        :   default: [-0.2 1.4]</li><li>seti.plotPublish    :   default: 0</li><li>seti.pubFontSize    :   default: 20</li><li>seti.plotVisible    :   default: 'off'</li><li>seti.savepng        :   default: 1</li><li>seti.saveepsc       :   default: 0</li><li>seti.savefig        :   default: 0</li><li>seti.plotFreqiPda   :   default: 0</li></ul></div><p>For the following output arguments see <a href="setGrid.html">setGrid.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.dim            :   default: 2</li><li>seti.rCD            :   default: 0.2</li><li>seti.nCD            :   default: 256</li></ul></div><p><i>Are set automatically</i>:</p><div><ul><li>seti.h              :   2*rCD/nCD</li><li>seti.dV</li><li>seti.grid           :   size: seti.dim x seti.nCD^seti.dim</li><li>seti.ballMask       :   size: seti.nCD x seti.nCD (logical)</li><li>seti.nROI</li><li>seti.gridROI        :   size: seti.dim x seti.nROI^seti.dim</li><li>seti.ROImask        :   size: nCD x nCD (logical)</li><li>seti.ballMaskROI    :   size: nROI x nROI (logical)</li></ul></div><p>For the following output arguments see <a href="setReshapeVecMat.html">setReshapeVecMat.html</a>:</p><p><i>Are set automatically:</i></p><div><ul><li>seti.GROI</li><li>seti.GCD</li><li>seti.G</li><li>seti.iG</li></ul></div><p>For the following output arguments see <a href="setGridScale.html">setGridScale.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.gscale     : default: 0</li><li>seti.nCDinv     :</li></ul></div><p><i>Are set automatically:</i></p><div><ul><li>seti.nInv       :</li><li>seti.hInv       :</li><li>seti.dVinv      :</li><li>seti.GInv       :</li><li>seti.GU         :</li><li>seti.GD         :</li></ul></div><p>For the following output arguments see <a href="setIdImagReal.html">setIdImagReal.html</a>:</p><p><i>Are set automatically:</i></p><div><ul><li>seti.S  :</li><li>seti.R  :</li><li>seti.I  :</li><li>seti.T  :</li></ul></div><p>For the following output arguments see <a href="setKernel.html">setKernel.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.k      : default: 250</li><li>seti.model  : default: 'helmholtz2D'</li></ul></div><p><i>Are set automatically:</i></p><div><ul><li>seti.kHat   : size nCD x nCD</li></ul></div><p>For the following output arguments see <a href="expSetup.html">expSetup.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.incType        :   default: 'pointSource'</li><li>seti.measType       :   default: 'nearField'</li><li>seti.incNb          :   default: 35</li><li>seti.measNb         :   default: 35</li><li>seti.radSrc         :   default: 5</li><li>seti.radMeas        :   default: 5</li><li>seti.incPntsType    :   default: 'circle'</li><li>seti.measPntsType   :   default: 'circle'</li></ul></div><p><i>Are set automatically:</i></p><div><ul><li>seti.incPnts        :   size seti.dim x seti.incNb</li><li>seti.dSInc          :</li><li>seti.measPnts       :   size seti.dim x seti.measNb</li><li>seti.dSMeas         :</li></ul></div><div><ul><li>seti.incField       :   complex matrix of size                           seti.nROI^seti.dim x seti.incNb</li><li>seti.measKer        :   complex matrix of size                           seti.measNb x seti.nROI^seti.dim</li></ul></div><p>For the following output arguments see <a href="setContrast.html">setContrast.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.contrast   :   default: 'cornerBallSparse2D'</li></ul></div><p><i>Are set automatically:</i></p><div><ul><li>seti.qCDexact   :   size: seti.nCD^seti.dim x 1</li><li>seti.qROIexact  :   size: seti.nROI^seti.dim x 1</li></ul></div><p>For the following output argument see <a href="setGeomSim.html">setGeomSim.html</a>:</p><p>Note that seti.mCD unequal 0 is not supported in public version.</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.mCD    :   default: 0</li></ul></div><p>For the following output arguments see <a href="addNoise.html">addNoise.html</a>:</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.delta      :   default: 0.01</li><li>seti.whichNoise :   default: 'normal'</li><li>seti.seed       :   default: 0</li></ul></div><p>The following output arguments are set in setData (this function):</p><p><i>Can be set by user (otherwise default is set)</i>:</p><div><ul><li>seti.loadFmeas      :   path to mat-file containing variables                           FmeasExact and FmeasDelta.                           (default: empty, i.e. '').</li><li>seti.useFmeasDelta  :   Set it to 1 to use FmeasDelta in loadFmeas                           (default: 1).</li></ul></div><p><i>Are set automatically:</i></p><div><ul><li>seti.FmeasExact     :   scattered field evaluated on receivers positions                           (complex matrix of size seti.measNb x seti.incNb),                           see also <a href="mimo.html">mimo.html</a>.</li><li>seti.FmeasDelta     :   FmeasExact with noise (synthetic data), see <a href="addNoise.html">addNoise.html</a>                           (complex matrix of size seti.measNb x seti.incNb).</li></ul></div><h2 id="6">References</h2><div><ul><li>[1] Florian B&uuml;rgel, Kamil S. Kazimierski, and Armin Lechleiter. A sparsity regularization and total variation based computational framework for the inverse medium problem in scattering. <i>Journal of Computational Physics</i>, 339:1-30, 2017.</li></ul></div><h2 id="7">See Also</h2><div><ul><li><a href="loadData.html">loadData.html</a></li><li><a href="setGeomSim.html">setGeomSim.html</a></li><li><a href="mimo.html">mimo.html</a></li><li><a href="addNoise.html">addNoise.html</a></li><li><a href="setInput.html">setInput.html</a></li></ul></div><div><ul><li><a href="matchIncField.html">matchIncField.html</a></li></ul></div><div><ul><li><a href="setGrid.html">setGrid.html</a></li><li><a href="setReshapeVecMat.html">setReshapeVecMat.html</a></li><li><a href="setGridScale.html">setGridScale.html</a></li><li><a href="setIdImagReal.html">setIdImagReal.html</a></li><li><a href="setKernel.html">setKernel.html</a></li><li><a href="expSetup.html">expSetup.html</a></li><li><a href="setContrast.html">setContrast.html</a></li></ul></div><h2 id="8">Code: setData</h2><div><ul><li>geometry of experimental set-up</li><li>grid generation</li><li>simulation of forward scattering and add noise to data</li><li>or read and process real-world data</li></ul></div><pre class="codeinput"><span class="keyword">function</span> seti = setData(seti,varargin)
</pre><pre class="codeinput"><span class="keyword">if</span> nargin == 1
    dispDepth = 0;
    out = 0; <span class="comment">% plot no figures</span>
<span class="keyword">elseif</span> nargin == 2
    dispDepth = varargin{1};
    out = 0;
<span class="keyword">elseif</span> nargin == 3
    dispDepth = varargin{1};
    out = varargin{2}; <span class="comment">% output: out = 1 plots figures, out = 2 additionally saves them</span>
<span class="keyword">else</span>
    error(<span class="string">'nargin has to be between 1 and 3.'</span>);
<span class="keyword">end</span>

<span class="keyword">if</span> isfield(seti,<span class="string">'expData'</span>) <span class="comment">% load real-world data</span>
    <span class="keyword">if</span> strcmp(seti.expData,<span class="string">'fresnel'</span>)
</pre><p><b>expData: Fresnel</b></p><pre class="codeinput">        seti = checkConsisExpData(seti,dispDepth);
        <span class="keyword">if</span> dispDepth &gt;= 1
            disp(<span class="string">'   Loading fresnel data from:'</span>)
            fprintf(<span class="string">'      %s\n'</span>,seti.fresnelFile)
            fprintf(<span class="string">'      for frequency %d GHz'</span>,seti.fresnelFreq/1E9)
        <span class="keyword">end</span>
        seti = loadData(seti,dispDepth,out); <span class="comment">% setGeomSim is called in loadData</span>
        <span class="comment">% seti.qROIexact exact contrast in ROI as a vector (or zeroes if no exact contrast available)</span>
        <span class="comment">% seti.FmeasDelta contains the Fresnel data</span>
</pre><pre class="codeinput">    <span class="keyword">elseif</span> strcmp(seti.expData,<span class="string">'simonetti'</span>)
</pre><p><b>expData: Simonetti</b></p><p>This case is not supported in public version.</p><pre class="codeinput">        disp(<span class="string">'loading Simonetti"s data'</span>) ;
        seti = loadSimonettiData(seti); <span class="comment">% setGeomSim is called in loadData</span>
        seti = setGeomSim(seti,dispDepth,out); <span class="comment">% set geometry and simulation</span>

        seti.FmeasDeltaSim = mimo(seti, seti.qROIexact, <span class="string">'simo'</span>);

        seti.FmeasDelta = seti.FmeasDelta/norm(seti.FmeasDelta)*norm(seti.FmeasDeltaSim);
        seti.FmeasExact = seti.FmeasExact/norm(seti.FmeasExact)*norm(seti.FmeasDeltaSim);

        <span class="keyword">if</span> ~isfield(seti,<span class="string">'gradMat'</span>)
            N = seti.nCD;
            N2 = ceil((seti.nCD-1)/2);
            seti.gradMat = circshift(diag((0:N-1)-N2), -N2*[1, 1]);
        <span class="keyword">end</span>
</pre><pre class="codeinput">    <span class="keyword">else</span>
        error(<span class="string">'seti.expData not found .. ?!?'</span>);
    <span class="keyword">end</span>
<span class="keyword">else</span>
</pre><p><b>Set data structures for geometry and simulation</b></p><pre class="codeinput">    <span class="keyword">if</span> dispDepth &gt;= 1
        disp(<span class="string">'-- setGeomSim --'</span>)
        disp(<span class="string">' '</span>)
    <span class="keyword">end</span>
    seti = setGeomSim(seti,dispDepth,out); <span class="comment">% set geometry and simulation</span>

    <span class="comment">% Create gradient structures if seti.model='helmholtzHMode2D'</span>
    <span class="comment">% Note that ...HMode... is not supported in public version.</span>
    <span class="keyword">if</span> strcmp(seti.model,<span class="string">'helmholtzHMode2D'</span>)
        <span class="keyword">if</span> ~isfield(seti,<span class="string">'gradMat'</span>)
            N = seti.nCD;
            N2 = ceil((seti.nCD-1)/2);
            seti.gradMat = circshift(diag((0:N-1)-N2), -N2*[1, 1]);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    seti = checkfield(seti,<span class="string">'loadFmeas'</span>,<span class="string">''</span>,dispDepth); <span class="comment">% default: '', so no load...</span>

    <span class="keyword">if</span> ~isempty(seti.loadFmeas)
<span class="comment">% -- load old: start --</span>
<span class="comment">% 		load(sprintf('%s',seti.loadFmeas)); % loads: FmeasExact and FmeasDelta</span>
<span class="comment">% 		seti.FmeasExact = FmeasExact; % exact data (just loaded)</span>
<span class="comment">% 		clear FmeasExact k directions;</span>
<span class="comment">% -- load old: end --</span>
<span class="comment">% -- load new start --</span>
		sloaded = load(sprintf(<span class="string">'%s'</span>,seti.loadFmeas)); <span class="comment">% loads: FmeasExact and FmeasDelta (in struct sloaded)</span>
		seti.FmeasExact = sloaded.FmeasExact; <span class="comment">% exact data (just loaded)</span>
<span class="comment">% -- load new end --</span>
        <span class="keyword">if</span> dispDepth &gt;= 1
            disp(<span class="string">' - FmeasExact and FmeasDelta loaded'</span>)
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        <span class="keyword">if</span> dispDepth &gt;= 1
            disp(<span class="string">' - FmeasExact (exact data) computation'</span>)
        <span class="keyword">end</span>
        <span class="comment">% Note that mimo is expensive if qROI does not have many entries with 0.</span>
        <span class="comment">% Define qROI before operator FF and then compute FmeasExact = FF(q).</span>
        <span class="comment">% Be careful with mimo and wavelets because mimo is FF(q)-FmeasDelta(!).</span>
        ticExact = tic;
		seti.FmeasExact = mimo(seti, seti.qROIexact, <span class="string">'simo'</span>);
        tocExact = toc(ticExact);
        <span class="keyword">if</span> dispDepth &gt;= 1
            fprintf(<span class="string">'   Elapsed time of computation of exact data is %05.1f min.\n'</span>,tocExact/60);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    seti = checkfield(seti,<span class="string">'useFmeasDelta'</span>,1,dispDepth);

    <span class="keyword">if</span> ~isempty(seti.loadFmeas) &amp;&amp; seti.useFmeasDelta == 1
        <span class="keyword">if</span> dispDepth &gt;= 1
            disp(<span class="string">'- use FmeasDelta (use loaded data with noise)'</span>)
        <span class="keyword">end</span>
        seti.FmeasDelta = sloaded.FmeasDelta; <span class="comment">% noisy data was loaded</span>
    <span class="keyword">else</span>
        <span class="comment">% -- add noise to data</span>
        <span class="keyword">if</span> dispDepth &gt;= 1
            disp(<span class="string">' - add noise to data'</span>)
        <span class="keyword">end</span>
        [seti, seti.FmeasDelta] = addNoise(seti,seti.FmeasExact,dispDepth);
    <span class="keyword">end</span>
    <span class="comment">% FmeasExact and FmeasDelta are saved in start.m (first construct seti.dirname)</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p><b>Save FmeasExact and FmeasDelta</b></p><pre class="codeinput"><span class="keyword">if</span> ~isfield(seti,<span class="string">'expData'</span>) &amp;&amp; out == 2
    saveDes = sprintf(<span class="string">'%s/save_Fmeas.mat'</span>,seti.dirname);
    FmeasExact = seti.FmeasExact; <span class="comment">%#ok (suppress MATLAB warning, because exact data will be saved)</span>
    FmeasDelta = seti.FmeasDelta; <span class="comment">%#ok (suppress MATLAB warning, because noisy data will be saved)</span>
    save(saveDes,<span class="string">'FmeasExact'</span>,<span class="string">'FmeasDelta'</span>);
    clear <span class="string">saveDes</span> <span class="string">FmeasExact</span> <span class="string">FmeasDelta</span>;
<span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% setData
% Sets geometry and experimental set-up, 
% simulates the scattered field and computes noisy data 
% (or loads real-world data).
%
%% Syntax
%
%   seti = setData(seti)
%   seti = setData(seti,dispDepth)
%   seti = setData(seti,dispDepth,out)
%
%% Description
%
% |seti = setData(seti)| essentially 
% sets the grids (seti.grid and seti.gridROI)
% as well as the transmitters and receivers positions (seti.incPnts and
% seti.measPnts), simulates the scattered field (seti.FmeasExact) and
% computes noisy data (seti.FmeasDelta) (or loads real-world data).
%
% |seti = setData(seti,dispDepth)| does the same as |seti = setData(seti)|
% but allows to control the depth of displayed messages by |dispDepth|.
%
% |seti = setData(seti,dispDepth,out)| does the same as |seti = setData(seti,dispDepth)| in 
% case of |out = 0|, but plots the figures in case of |out = 1| and 
% additionally saves them in case of |out = 2|.
%
% * If |seti.expData = 'fresnel'| real-world data from 
% Institute Fresnel are loaded (see <loadData.html>), i.e. the measurements of the incident 
% fields and total fields are loaded, the corresponding geometry and 
% simulation is done, and the incident field is matched.
%
% * If |seti.loadFmeas| contains a path, |FmeasExact| and |FmeasDelta| are
% loaded.
% * Note that |FmeasDelta| is only used if |seti.useFmeasDelta| was set to 1
% (otherwise data with noise is generated again).
%
% * If no field |expData| of |seti| exists and |out| equals 2, the exact
% and simulated data |seti.FmeasExact| and |seti.FmeasDelta| are saved as
% |FmeasExact| and |FmeasDelta| in a file |save_Fmeas.mat|. (Exactly this
% file can be loaded by |seti.loadFmeas|.)
%
% *Structure of the function*
%
% * The set of geometry and simulation (see <setGeomSim.html>) essentially sets
% general settings for figures, 
% the grids (computational domain (CD) and region of interest (ROI)), 
% the kernel, the experimental set-up, and the predefined contrast.
% * The the scattered field is simulated by <mimo.html>.
% * Noise is added by <addNoise.html>.
%
% 
%% Example
%
% *Example 1*
%
%  init;                    % initialization
%  seti = struct;           % create empty structural array
%  seti = setData(seti);    % compute but do not plot or store figures
%
% *Example 2*
%
%  init;
%  seti = struct;
%  seti = setData(seti,4);  % display output messages
%
% *Example 3*
%
%  init;
%  setInput;   % set input and make directories for output
%  seti = setData(seti,4,2);    % display output messages; plot and save files and figures
%
%% Input Arguments
%
% For a description of the following input arguments see <setInput.html>.
%
% * |inseti|
% * |seti|
% * |usevaralpha|
% * |usevarbeta|
% * |usevardelta|
% * |usevartol|
%
% Note that many of the output arguments can by set in the struct seti as 
% input arguments. This fields are marked by 
% "Can be set by user (otherwise default is set)".
%
% We only mention explictly the input arguments to deal with experimentally
% measured data from Institute Fresnel.
%
% * seti.expData    :   Set 'fresnel' to load real-world data
%                       (experimentally measured) from Institute Fresnel.
%
% *The following parameters can be set by user only in case of 
%  seti.expData = 'fresnel'*
% 
% For further details see <loadData.html> and <matchIncField.html>.
%
% * seti.fresnelFreq    :   frequency of Fresnel data set in Hz
%                           (default: 5e+09)
% * seti.fresnelFile    :   path to real-world data
%                           (default:
%                           'inexpdata/fresnel_opus_1/twodielTM_8f.exp')
%                           (Make sure to use data with |TM| in the filemname,
%                           which stands for transverse magnetic (TM) 
%                           polarization, because the Helmholtz equation
%                           only models electromagnetic waves in the TM
%                           case, see Section 2 in [1].)
% * seti.nuMax          :   match incident field parameter (default: 7)
% * seti.ampCalc        :   method to compute the coefficients c (1, 2 or 3),
%                           we recommend to use method 1.
%
% *Optional Input Argument*
%
% * dispDepth     : depth of displayed messages in dependence of
% |dispDepth| (number between 0 and 5).
% * out           : output depth: no figure (0), plot figure (1), 
%                   plot and save figure (2).
%
%% Output Arguments
%
% * seti    :   structure array
%
% For the following output arguments see <setGeomSim.html>:
%
% * seti.tol
%
%
% For the following output arguments see Subfunction |setFigureSettings| in
% <setGeomSim.html>:
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.plotFreq       :   default: 1
% * seti.usecbarlim     :   default: 1
% * seti.cbarlim        :   default: [-0.2 1.4]
% * seti.plotPublish    :   default: 0
% * seti.pubFontSize    :   default: 20
% * seti.plotVisible    :   default: 'off'
% * seti.savepng        :   default: 1
% * seti.saveepsc       :   default: 0
% * seti.savefig        :   default: 0
% * seti.plotFreqiPda   :   default: 0
%
% For the following output arguments see <setGrid.html>:
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.dim            :   default: 2
% * seti.rCD            :   default: 0.2
% * seti.nCD            :   default: 256
%
% _Are set automatically_:
%
% * seti.h              :   2*rCD/nCD
% * seti.dV
% * seti.grid           :   size: seti.dim x seti.nCD^seti.dim
% * seti.ballMask       :   size: seti.nCD x seti.nCD (logical)
% * seti.nROI
% * seti.gridROI        :   size: seti.dim x seti.nROI^seti.dim
% * seti.ROImask        :   size: nCD x nCD (logical)
% * seti.ballMaskROI    :   size: nROI x nROI (logical)
%
% For the following output arguments see <setReshapeVecMat.html>:
%
% _Are set automatically:_
%
% * seti.GROI
% * seti.GCD
% * seti.G
% * seti.iG
%
% For the following output arguments see <setGridScale.html>:
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.gscale     : default: 0
% * seti.nCDinv     :
%
% _Are set automatically:_
%
% * seti.nInv       :
% * seti.hInv       :
% * seti.dVinv      :
% * seti.GInv       :
% * seti.GU         :
% * seti.GD         :
%
% For the following output arguments see <setIdImagReal.html>:
% 
% _Are set automatically:_
%
% * seti.S  :   
% * seti.R  :   
% * seti.I  :   
% * seti.T  :   
%
% For the following output arguments see <setKernel.html>:
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.k      : default: 250
% * seti.model  : default: 'helmholtz2D'
%
% _Are set automatically:_
%
% * seti.kHat   : size nCD x nCD
%
% For the following output arguments see <expSetup.html>:
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.incType        :   default: 'pointSource'
% * seti.measType       :   default: 'nearField'
% * seti.incNb          :   default: 35
% * seti.measNb         :   default: 35
% * seti.radSrc         :   default: 5
% * seti.radMeas        :   default: 5
% * seti.incPntsType    :   default: 'circle'
% * seti.measPntsType   :   default: 'circle'
%
% _Are set automatically:_
%
% * seti.incPnts        :   size seti.dim x seti.incNb
% * seti.dSInc          :   
% * seti.measPnts       :   size seti.dim x seti.measNb
% * seti.dSMeas         :   
% 
% * seti.incField       :   complex matrix of size 
%                           seti.nROI^seti.dim x seti.incNb
% * seti.measKer        :   complex matrix of size 
%                           seti.measNb x seti.nROI^seti.dim
%
% For the following output arguments see <setContrast.html>:
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.contrast   :   default: 'cornerBallSparse2D'
%
% _Are set automatically:_
%
% * seti.qCDexact   :   size: seti.nCD^seti.dim x 1
% * seti.qROIexact  :   size: seti.nROI^seti.dim x 1
%
%
% For the following output argument see <setGeomSim.html>:
%
% Note that seti.mCD unequal 0 is not supported in public version.
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.mCD    :   default: 0
% 
% For the following output arguments see <addNoise.html>:
% 
% _Can be set by user (otherwise default is set)_:
%
% * seti.delta      :   default: 0.01
% * seti.whichNoise :   default: 'normal'
% * seti.seed       :   default: 0
%
% The following output arguments are set in setData (this function):
%
% _Can be set by user (otherwise default is set)_:
%
% * seti.loadFmeas      :   path to mat-file containing variables 
%                           FmeasExact and FmeasDelta.
%                           (default: empty, i.e. '').
% * seti.useFmeasDelta  :   Set it to 1 to use FmeasDelta in loadFmeas
%                           (default: 1).
%
% _Are set automatically:_
%
% * seti.FmeasExact     :   scattered field evaluated on receivers positions 
%                           (complex matrix of size seti.measNb x seti.incNb),
%                           see also <mimo.html>.
% * seti.FmeasDelta     :   FmeasExact with noise (synthetic data), see <addNoise.html>
%                           (complex matrix of size seti.measNb x seti.incNb).
%
%
%% References
%
% * [1] Florian B&uuml;rgel, Kamil S. Kazimierski, and Armin Lechleiter. A sparsity regularization and total variation based computational framework for the inverse medium problem in scattering. _Journal of Computational Physics_, 339:1-30, 2017.
%
%% See Also
%
% * <loadData.html>
% * <setGeomSim.html>
% * <mimo.html>
% * <addNoise.html>
% * <setInput.html>
%
% * <matchIncField.html>
%
% * <setGrid.html>
% * <setReshapeVecMat.html>
% * <setGridScale.html>
% * <setIdImagReal.html>
% * <setKernel.html>
% * <expSetup.html>
% * <setContrast.html>
%
%
%% Code: setData
% * geometry of experimental set-up
% * grid generation
% * simulation of forward scattering and add noise to data
% * or read and process real-world data
%

function seti = setData(seti,varargin)

if nargin == 1
    dispDepth = 0;
    out = 0; % plot no figures
elseif nargin == 2
    dispDepth = varargin{1};
    out = 0;
elseif nargin == 3
    dispDepth = varargin{1};
    out = varargin{2}; % output: out = 1 plots figures, out = 2 additionally saves them
else
    error('nargin has to be between 1 and 3.');
end

if isfield(seti,'expData') % load real-world data
    if strcmp(seti.expData,'fresnel')
        %%
        % *expData: Fresnel*
        seti = checkConsisExpData(seti,dispDepth);
        if dispDepth >= 1
            disp('   Loading fresnel data from:')
            fprintf('      %s\n',seti.fresnelFile)
            fprintf('      for frequency %d GHz',seti.fresnelFreq/1E9)
        end
        seti = loadData(seti,dispDepth,out); % setGeomSim is called in loadData
        % seti.qROIexact exact contrast in ROI as a vector (or zeroes if no exact contrast available)
        % seti.FmeasDelta contains the Fresnel data
    elseif strcmp(seti.expData,'simonetti')
        %%
        % *expData: Simonetti*
        %
        % This case is not supported in public version.
        %
        disp('loading Simonetti"s data') ;
        seti = loadSimonettiData(seti); % setGeomSim is called in loadData
        seti = setGeomSim(seti,dispDepth,out); % set geometry and simulation
        
        seti.FmeasDeltaSim = mimo(seti, seti.qROIexact, 'simo');
        
        seti.FmeasDelta = seti.FmeasDelta/norm(seti.FmeasDelta)*norm(seti.FmeasDeltaSim);
        seti.FmeasExact = seti.FmeasExact/norm(seti.FmeasExact)*norm(seti.FmeasDeltaSim);

        if ~isfield(seti,'gradMat')
            N = seti.nCD;
            N2 = ceil((seti.nCD-1)/2);
            seti.gradMat = circshift(diag((0:N-1)-N2), -N2*[1, 1]);
        end
    else
        error('seti.expData not found .. ?!?');
    end
else
    %%
    % *Set data structures for geometry and simulation*
    %
    if dispDepth >= 1
        disp('REPLACE_WITH_DASH_DASH setGeomSim REPLACE_WITH_DASH_DASH')
        disp(' ')
    end
    seti = setGeomSim(seti,dispDepth,out); % set geometry and simulation

    % Create gradient structures if seti.model='helmholtzHMode2D'
    % Note that ...HMode... is not supported in public version.
    if strcmp(seti.model,'helmholtzHMode2D')
        if ~isfield(seti,'gradMat')
            N = seti.nCD;
            N2 = ceil((seti.nCD-1)/2);
            seti.gradMat = circshift(diag((0:N-1)-N2), -N2*[1, 1]);
        end
    end
    
    seti = checkfield(seti,'loadFmeas','',dispDepth); % default: '', so no load...
   
    if ~isempty(seti.loadFmeas)
% REPLACE_WITH_DASH_DASH load old: start REPLACE_WITH_DASH_DASH
% 		load(sprintf('%s',seti.loadFmeas)); % loads: FmeasExact and FmeasDelta
% 		seti.FmeasExact = FmeasExact; % exact data (just loaded)
% 		clear FmeasExact k directions;
% REPLACE_WITH_DASH_DASH load old: end REPLACE_WITH_DASH_DASH
% REPLACE_WITH_DASH_DASH load new start REPLACE_WITH_DASH_DASH
		sloaded = load(sprintf('%s',seti.loadFmeas)); % loads: FmeasExact and FmeasDelta (in struct sloaded)
		seti.FmeasExact = sloaded.FmeasExact; % exact data (just loaded)
% REPLACE_WITH_DASH_DASH load new end REPLACE_WITH_DASH_DASH
        if dispDepth >= 1
            disp(' - FmeasExact and FmeasDelta loaded')
        end
    else
        if dispDepth >= 1
            disp(' - FmeasExact (exact data) computation')
        end
        % Note that mimo is expensive if qROI does not have many entries with 0.
        % Define qROI before operator FF and then compute FmeasExact = FF(q).
        % Be careful with mimo and wavelets because mimo is FF(q)-FmeasDelta(!).
        ticExact = tic;
		seti.FmeasExact = mimo(seti, seti.qROIexact, 'simo');
        tocExact = toc(ticExact);
        if dispDepth >= 1
            fprintf('   Elapsed time of computation of exact data is %05.1f min.\n',tocExact/60);
        end
    end
    
    seti = checkfield(seti,'useFmeasDelta',1,dispDepth);
    
    if ~isempty(seti.loadFmeas) && seti.useFmeasDelta == 1
        if dispDepth >= 1
            disp('- use FmeasDelta (use loaded data with noise)')
        end
        seti.FmeasDelta = sloaded.FmeasDelta; % noisy data was loaded
    else
        % REPLACE_WITH_DASH_DASH add noise to data
        if dispDepth >= 1
            disp(' - add noise to data')
        end
        [seti, seti.FmeasDelta] = addNoise(seti,seti.FmeasExact,dispDepth);
    end
    % FmeasExact and FmeasDelta are saved in start.m (first construct seti.dirname)
end

%% 
% *Save FmeasExact and FmeasDelta*
%
if ~isfield(seti,'expData') && out == 2
    saveDes = sprintf('%s/save_Fmeas.mat',seti.dirname);
    FmeasExact = seti.FmeasExact; %#ok (suppress MATLAB warning, because exact data will be saved)
    FmeasDelta = seti.FmeasDelta; %#ok (suppress MATLAB warning, because noisy data will be saved)
    save(saveDes,'FmeasExact','FmeasDelta');
    clear saveDes FmeasExact FmeasDelta;
end

end

##### SOURCE END #####
--></body></html>