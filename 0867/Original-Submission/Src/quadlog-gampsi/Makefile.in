#=======================================================================
# Makefile for files in /u/sy/beebe/jim-ball/toms/dist
#
# This directory contains no source files itself, but this Makefile
# directs the compilation, linking, testing, et al targets in each of
# its subdirectories.
#
# Current target list:
#	all			make everything
#	check			run validation suite
#	clean			remove some intermediate files
#	clobber			same as distclean
#	configure		patch a newly-generated configure file
#	dist			make distribution archive
#	distclean		remove almost everything that make can
#				rebuild, returning the directory to the
#				state of the original distribution
#	dw			doubled-word check
#	install			install software on local system
#	install-lib		install libraries only
#	install-show		show what has been installed
#	maintainer-clean	remove absolutely everything that make
#				can rebuilds; do NOT use this: it may
#				need tools that are available only at
#				the authors' site.
#	mostlyclean		remove all intermediate files
#	spell			spelling check
#	uninstall		remove installed files from local system
#	uninstall-lib		remove only installed libraries
#
# [12-Dec-2000] -- minor update of "all" target
# [03-Jun-2000]
#=======================================================================

prefix		= @prefix@

libdir		= $(prefix)/lib

#=======================================================================
# Programs:

CP		= cp

CHMOD		= chmod


DISTFILES       = $(DISTSLIM) \
		  dist/jacobi/test \
		  dist/laguerre/test

DISTSLIM	= dist/TO-THE-EDITOR \
		  dist/AUTHOR.gam \
		  dist/AUTHOR.std \
		  dist/INSTALL \
		  dist/MKDIRS \
		  dist/Makefile.in \
		  dist/README \
		  dist/SEEALSO.txt \
		  dist/configure \
		  dist/configure.in \
		  dist/doincl.awk \
		  dist/fortoman.awk \
		  dist/fortoman.sh \
		  dist/gjl.h \
		  dist/install-sh \
		  dist/makedepends.sh \
		  dist/common/*.f \
		  dist/common/*.in \
		  dist/common/*.inc \
		  dist/common/*.pch \
		  dist/common/*.pgi \
		  dist/common/*.sh \
		  dist/common/*.sok \
		  dist/common/MKDIRS \
		  dist/common/README \
		  dist/common/configure \
		  dist/common/save \
		  dist/jacobi/*.f \
		  dist/jacobi/*.in \
		  dist/jacobi/intomap.awk \
		  dist/jacobi/intomath.awk \
		  dist/jacobi/configure \
		  dist/jacobi/save \
		  dist/jacobi/MKDIRS \
		  dist/jacobi/README \
		  dist/jacobi/test/okay/dem*.out \
		  dist/jacobi/test/okay/*.nbs \
		  dist/jacobi/test/okay/*.ls? \
		  dist/laguerre/cglfd1.c \
		  dist/laguerre/*.f \
		  dist/laguerre/*.in \
		  dist/laguerre/configure \
		  dist/laguerre/save \
		  dist/laguerre/MKDIRS \
		  dist/laguerre/README \
		  dist/laguerre/test/okay/dem*.out \
		  dist/laguerre/test/okay/*.nbs \
		  dist/laguerre/test/okay/*.ls? \
		  dist/man/*.html \
		  dist/man/*.in \
		  dist/man/*.man \
		  dist/man/*.pdf \
		  dist/man/*.ps \
		  dist/man/*.sok \
		  dist/man/MKDIRS \
		  dist/man/README \
		  dist/man/configure \
		  dist/man/man2ps \
		  dist/man/save

GZIP		= gzip

LS		= ls

RANLIB		= ranlib

RM		= rm -f

SHELL		= /bin/sh

TAR		= tar

#=======================================================================
# Compiler flags and source files

FOPT		= -O

# These options are useful for the GNU g77 compiler (== f77 on
# GNU/Linux) to expose possible problems in the source code.  You must
# also set FOPT=-O for -Wuninitialized to produce diagnostics.
FWARN		= -pedantic  \
		  -W  \
		  -Wid-clash-6 \
		  -Wimplicit  \
		  -Wno-globals  \
		  -Wsurprising  \
		  -Wuninitialized  \
		  -Wunused

# Normally, however, we have an empty value for FWARN:
FWARN		=

LIBNAME		= libgjl

LIBRARY		= $(LIBNAME).a

# NB: Subdirectory common must be last, so that "make distclean" does
# not remove its Makefile before the others are finished using it!
SUBDIRS		= man gampsi jacobi laguerre common

SUBDIRLOOP	= for subdir in $(SUBDIRS) ; \
		do \
			echo ============================== Making $@ in $$subdir ; \
			( cd $$subdir && $(MAKE) $(MFLAGS) prefix=$(prefix) FWARN="$(FWARN)" FOPT="$(FOPT)" $@ ) ; \
		done

#=======================================================================
# Targets:

# NB: We need to do the build in common first, since the other
# packages expect to be able to find .o files there: although some
# make implementations can handle the construction of .o files in
# another directory automatically, not all do.  See the note above
# about why common cannot appear first in SUBDIRS.
all:
	(cd common && $(MAKE) $(MFLAGS) prefix=$(prefix) FWARN="$(FWARN)" FOPT="$(FOPT)" $@ )
	$(SUBDIRLOOP)

all-qp:
	(cd common && $(MAKE) $(MFLAGS) prefix=$(prefix) FWARN="$(FWARN)" FOPT="$(FOPT)" $@ )
	$(SUBDIRLOOP)

check:	check-dp

check-dp:
	-$(SUBDIRLOOP)

check-qp:
	-$(SUBDIRLOOP)

clean:
	-$(RM) *.dcl
	-$(RM) *.dw
	-$(RM) *.i
	-$(RM) *.o
	-$(RM) *.ser
	-$(RM) *.stb
	-$(RM) *.stx
	-$(RM) *.u
	-$(RM) *~
	-$(RM) \#*
	-$(RM) a.out
	-$(RM) core
	-$(RM) tg_[0-9][0-9][0-9][0-9][0-9].*
	-$(SUBDIRLOOP)

clobber:	distclean

demo:	demo-dp

demo-dp:
	-$(SUBDIRLOOP)

demo-qp:
	-$(SUBDIRLOOP)

dist:
	(cd ..; $(TAR) cf - $(DISTFILES) | $(GZIP) -9 > /tmp/quadlog.tar.gz)
	$(LS) -l /tmp/quadlog.tar.gz

distslim:
	(cd ..; $(TAR) cf - $(DISTSLIM) | $(GZIP) -9 > /tmp/quadlog-slim.tar.gz)
	@$(LS) -l /tmp/quadlog-slim.tar.gz

dw:
	(cd man; $(MAKE) $@)

distclean:	mostlyclean
	-$(RM) *.d
	-$(RM) *.tcov
	-$(RM) $(LIBRARY)
	-$(SUBDIRLOOP)
	-$(RM) config.cache config.status config.log Makefile

install:	install-lib
	$(SUBDIRLOOP)
	-$(MAKE) install-show

install-lib:	uninstall-lib
	-$(RM) $(libdir)/$(LIBRARY)
	$(CP) $(LIBRARY) $(libdir)/
	$(CHMOD) 664 $(libdir)/$(LIBRARY)
	$(RANLIB) $(libdir)/$(LIBRARY) || true

install-show:
	(cd man; $(MAKE) $@)
	@$(LS) -l $(libdir)/$(LIBRARY)

maintainer-clean:	distclean
	@echo "This command is intended for maintainers to use;"
	@echo "it deletes files that may require special tools to rebuild."
	-$(SUBDIRLOOP)

mostlyclean:	clean
	-$(SUBDIRLOOP)

spell:
	(cd man; $(MAKE) $@)

uninstall: uninstall-lib
	-$(SUBDIRLOOP)

uninstall-lib:
	-$(RM) $(libdir)/$(LIBRARY)

#=======================================================================
